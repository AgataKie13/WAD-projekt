---
title: "Wielowymiarowa analiza jakoÅ›ci wina na podstawie danych ..."
author: "Agata Kierznikowicz, Zuzanna ÅomÅ¼a"
date: "2025-12-05"
output: rmdformats::readthedown
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Biblioteki:
library(readr)
library(skimr)
library(dplyr)
library(corrplot) 
library(psych)  
library(ggplot2)
library(tidyr)
library(kableExtra)
library(broom)
library(patchwork)
library(DT)
library(naniar)
library(moments)
library(ggcorrplot)
library(factoextra)
library(NbClust) 
library(cluster)
```

# 1. Wprowadzenie

## 1.1. Motywacja i cel pracy

::: {style="text-align: justify;"}
Rezerwacje hotelowe sÄ… integralnÄ… czÄ™Å›ciÄ… branÅ¼y turystycznej i
hotelarskiej, ktÃ³ra dynamicznie siÄ™ rozwija i w ktÃ³rej decyzje biznesowe
w duÅ¼ej mierze opierajÄ… siÄ™ na danych. KaÅ¼dego dnia hotele przyjmujÄ…
setki, a nawet tysiÄ…ce goÅ›ci, a systemy rezerwacyjne gromadzÄ…
szczegÃ³Å‚owe informacje o czasie dokonania rezerwacji, liczbie osÃ³b,
dÅ‚ugoÅ›ci pobytu, typie hotelu czy dodatkowych usÅ‚ugach. ChoÄ‡ dane te sÄ…
dostÄ™pne, rzadko analizuje siÄ™ je kompleksowo, aby zrozumieÄ‡ wzorce
zachowaÅ„ klientÃ³w i czynniki wpÅ‚ywajÄ…ce na anulowanie rezerwacji.

ZbiÃ³r danych o rezerwacjach hotelowych zawiera wiele powiÄ…zanych ze sobÄ…
zmiennych, takich jak typ hotelu, czas oczekiwania na przyjazd, liczba
dorosÅ‚ych i dzieci, sezonowoÅ›Ä‡, liczba wczeÅ›niejszych anulacji czy
liczba specjalnych prÃ³Å›b. PoniewaÅ¼ cech jest wiele i mogÄ… one wpÅ‚ywaÄ‡ na
siebie nawzajem, trudno jest je analizowaÄ‡ pojedynczo. Dlatego w
projekcie zastosowano metody wielowymiarowej analizy danych, ktÃ³re
pozwalajÄ… zidentyfikowaÄ‡ najwaÅ¼niejsze zaleÅ¼noÅ›ci i wzorce w zbiorze
danych.

Celem projektu jest lepsze zrozumienie zachowaÅ„ klientÃ³w hotelowych,
identyfikacja czynnikÃ³w wpÅ‚ywajÄ…cych na anulowanie rezerwacji oraz
wykrycie naturalnych grup rezerwacji, ktÃ³re rÃ³Å¼niÄ… siÄ™ miÄ™dzy sobÄ… pod
wzglÄ™dem charakterystyki goÅ›ci i wzorcÃ³w pobytu. W tym celu wykorzystano
m.in. analizÄ™ gÅ‚Ã³wnych skÅ‚adowych (PCA), metody klasteryzacji oraz inne
techniki eksploracyjne, ktÃ³re pomagajÄ… uporzÄ…dkowaÄ‡ dane i wydobyÄ‡
najwaÅ¼niejsze informacje.

**GÅ‚Ã³wne cele projektu to:**

-   zbadanie zaleÅ¼noÅ›ci miÄ™dzy rÃ³Å¼nymi cechami rezerwacji hotelowych,
-   identyfikacja zmiennych, ktÃ³re najbardziej wpÅ‚ywajÄ… na anulowanie
    rezerwacji,
-   zastosowanie PCA do redukcji wymiarowoÅ›ci i interpretacji
    skÅ‚adowych,
-   wykrycie naturalnych grup rezerwacji przy uÅ¼yciu metod analizy
    skupieÅ„ (klastrÃ³w),
-   ocena przydatnoÅ›ci zastosowanych metod w analizie danych hotelowych
    i podejmowaniu decyzji biznesowych.
:::

## 1.2. Opis problemu badawczego

::: {style="text-align: justify;"}
PowyÅ¼ej przedstawiono ogÃ³lny kontekst problemu zwiÄ…zanego z rezerwacjami
hotelowymi. ZbiÃ³r danych zawiera wiele zmiennych opisujÄ…cych rezerwacje
â€“ zarÃ³wno cechy goÅ›ci, jak i szczegÃ³Å‚y dotyczÄ…ce pobytu czy anulowania
rezerwacji. Ich wzajemne powiÄ…zania sÄ… zÅ‚oÅ¼one i trudne do analizy bez
zastosowania odpowiednich metod statystycznych i eksploracyjnych.

W zwiÄ…zku z tym w projekcie naleÅ¼y odpowiedzieÄ‡ na kilka kluczowych
pytaÅ„ badawczych:

-   KtÃ³re cechy rezerwacji (np. czas oczekiwania na przyjazd, liczba
    osÃ³b, typ hotelu) sÄ… ze sobÄ… najsilniej powiÄ…zane?
-   KtÃ³re zmienne majÄ… najwiÄ™kszy wpÅ‚yw na anulowanie rezerwacji?
-   Czy moÅ¼na zidentyfikowaÄ‡ naturalne grupy rezerwacji, np. wedÅ‚ug
    charakterystyki goÅ›ci, typu hotelu lub wzorcÃ³w pobytu?
-   Czy zastosowanie metod redukcji wymiarowoÅ›ci (np. PCA) pozwala
    lepiej zrozumieÄ‡ strukturÄ™ danych i uÅ‚atwia interpretacjÄ™ powiÄ…zaÅ„
    miÄ™dzy zmiennymi?
:::

## 1.3. Opis danych

::: {style="text-align: justify;"}
Dane wykorzystane w projekcie pochodzÄ… z publicznego repozytorium Kaggle
i sÄ… dostÄ™pne pod adresem
<https://www.kaggle.com/datasets/mojtaba142/hotel-booking>. ZbiÃ³r
obejmuje rezerwacje dokonane w dwÃ³ch typach hoteli â€“ city hotel i resort
hotel â€“ w okresie od lipca 2015 do sierpnia 2017. Dane sÄ… kompletne,
liczne i dobrze przystosowane do analiz wielowymiarowych.

Jako **zmiennÄ… objaÅ›nianÄ…** przyjÄ™to zmiennÄ… *is_canceled*, ktÃ³ra
wskazuje, czy rezerwacja zostaÅ‚a anulowana. PozostaÅ‚e zmienne iloÅ›ciowe
i kategoryczne podzielono na grupy w zaleÅ¼noÅ›ci od ich potencjalnego
wpÅ‚ywu na ryzyko anulowania rezerwacji, co pozwala badaÄ‡ zarÃ³wno
czynniki stymulujÄ…ce, jak i hamujÄ…ce rezerwacje.

**Struktura zbioru:**

-   liczba obserwacji: 119 390
-   liczba zmiennych: 36

***Zmienna objaÅ›niana:***

-   *is_canceled*

***Zmienne objaÅ›niajÄ…ce:***

*Stymulanty* - ich wzrost zmniejsza prawdopodobieÅ„stwo anulowania
pobytu:

1.  previous_bookings_not_canceled â†’ lojalnoÅ›Ä‡ klienta,
2.  is_repeated_guest â†’ lojalnoÅ›Ä‡ klienta,
3.  total_of_special_requests â†’ wiÄ™ksze zaangaÅ¼owanie klienta,
4.  stays_in_weekend_nights â†’ dÅ‚uÅ¼szy pobyt â†’ mniejsza szansa
    anulowania,
5.  stays_in_week_nights â†’ dÅ‚uÅ¼szy pobyt â†’ mniejsza szansa anulowania,
6.  adults â†’ rezerwacje rodzinne sÄ… stabilniejsze,
7.  children â†’ rezerwacje rodzinne sÄ… stabilniejsze,
8.  babies â†’ rezerwacje rodzinne sÄ… stabilniejsze,
9.  required_car_parking_spaces â†’ klient raczej planuje przyjazd.

*Destymulanty* - ich wzrost zwiÄ™ksza ryzyko anulowania:

10. lead_time â†’ im wczeÅ›niej rezerwacja, tym wiÄ™ksza szansa anulowania,
11. previous_cancellations â†’ historia anulowaÅ„,
12. booking_changes â†’ niestabilnoÅ›Ä‡ rezerwacji,
13. days_in_waiting_list â†’ niepewnoÅ›Ä‡ dostÄ™pnoÅ›ci,
14. adr (Å›rednia cena za noc) â†’ droÅ¼sze rezerwacje czÄ™Å›ciej anulowane.

*Nominanty* - Å›wietnie nadajÄ… siÄ™ do kodowania, mogÄ… wejÅ›Ä‡ do PCA (po
kodowaniu) lub klasteryzacji

15. arrival_date_month,
16. arrival_date_week_number,
17. hotel (City / Resort),
18. market_segment,
19. distribution_channel,
20. meal,
21. country,
22. reserved_room_type,
23. assigned_room_type,
24. deposit_type,
25. customer_type.

*PozostaÅ‚e zmienne* i ich zastosowanie analityczne w projekcie

-   **arrival_date_year**, **arrival_date_day_of_month** â†’ zmienne
    czasowe, ktÃ³re moÅ¼na jedynie wykorzystaÄ‡ do analizy kontekstowej
    oraz tworzenia nowych cech;

-   **reservation_status**, **reservation_status_date** â†’ zmienne
    opisujÄ…ce status rezerwacji sÄ… bezpoÅ›rednio powiazane ze zmiennÄ…
    objaÅ›niajÄ…cÄ… *(!trzeba zrobiÄ‡ macierz korelacji!)*; zostaÅ‚y
    wykluczone z modelowania, aby uniknÄ…Ä‡ wycieku informacji (data
    leakage);

-   **agent**, **company**, **name**, **email**, **phone.number**,
    **credit_card** â†’ zmienne identyfikujÄ…ce o braku interpretacji
    ekonomicznej i istotnoÅ›ci analitycznej, zawierajÄ… bardzo duÅ¼o
    kategorii, przez co mogÄ… zdominowaÄ‡ PCA; zostaÅ‚y wykluczone z
    modelowania, ale zostajÄ… do opisu danych.
:::

```{r wczytywanie danych i przeksztaÅ‚cenia zmiennych, echo=FALSE, results='asis'}
# 1. Import danych 
hotel <- read.csv("hotel_booking.csv", header=TRUE, sep=',')

# 2. Zmiana nazw na polskie
hotel <- hotel %>%
  rename(
  "odwoÅ‚anie_rezerwacji" = "is_canceled",
  "wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane" = "previous_bookings_not_canceled",
  "powracajÄ…cy_goÅ›Ä‡" = "is_repeated_guest",
  "liczba_specjalnych_prÃ³Å›b" = "total_of_special_requests",
  "liczba_nocy_weekendowych" = "stays_in_weekend_nights",
  "liczba_nocy_tygodniowych" = "stays_in_week_nights",
  "liczba_dorosÅ‚ych" = "adults",
  "liczba_dzieci" = "children",
  "liczba_niemowlÄ…t" = "babies",
  "wymagane_miejsca_parkingowe" = "required_car_parking_spaces",
  "czas_wyprzedzenia_rezerwacji" = "lead_time",
  "wczeÅ›niejsze_odwoÅ‚ania" = "previous_cancellations",
  "liczba_zmian_rezerwacji" = "booking_changes",
  "liczba_dni_na_liÅ›cie_oczekujÄ…cych" = "days_in_waiting_list",
  "Å›rednia_cena_za_noc" = "adr",
  "miesiÄ…c_przyjazdu" = "arrival_date_month",
  "numer_tygodnia_przyjazdu" = "arrival_date_week_number",
  "typ_hotelu" = "hotel",
  "segment_rynku" = "market_segment",
  "kanaÅ‚_dystrybucji" = "distribution_channel",
  "rodzaj_wyÅ¼ywienia" = "meal",
  "kraj_pochodzenia" = "country",
  "rodzaj_zarezerwowanego_pokoju" = "reserved_room_type",
  "rodzaj_przydzielonego_pokoju" = "assigned_room_type",
  "rodzaj_depozytu" = "deposit_type",
  "typ_klienta" = "customer_type",
  "rok_przyjazdu" = "arrival_date_year",
  "dzieÅ„_przyjazdu_w_miesiÄ…cu" = "arrival_date_day_of_month",
  "status_rezerwacji" = "reservation_status",
  "data_statusu_rezerwacji" = "reservation_status_date",
  "agent_rezerwacji" = "agent",
  "firma" = "company",
  "imiÄ™_i_nazwisko" = "name",
  "adres_email" = "email",
  "numer_telefonu" = "phone.number",
  "numer_karty_kredytowej" = "credit_card")

# 3. Ustalenie wpÅ‚ywu zmiennych objaÅ›niajÄ…cych na zmiennÄ… objaÅ›nianÄ…
stymulanty <- c(
  "wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane",
  "powracajÄ…cy_goÅ›Ä‡",
  "liczba_specjalnych_prÃ³Å›b",
  "liczba_nocy_weekendowych",
  "liczba_nocy_tygodniowych",
  "liczba_dorosÅ‚ych",
  "liczba_dzieci",
  "liczba_niemowlÄ…t",
  "wymagane_miejsca_parkingowe")

destymulanty <- c(
  "czas_wyprzedzenia_rezerwacji",
  "wczeÅ›niejsze_odwoÅ‚ania",
  "liczba_zmian_rezerwacji",
  "liczba_dni_na_liÅ›cie_oczekujÄ…cych",
  "Å›rednia_cena_za_noc")

nominanty <- c(
  "miesiÄ…c_przyjazdu",
  "numer_tygodnia_przyjazdu",
  "typ_hotelu",
  "segment_rynku",
  "kanaÅ‚_dystrybucji",
  "rodzaj_wyÅ¼ywienia",
  "kraj_pochodzenia",
  "rodzaj_zarezerwowanego_pokoju",
  "rodzaj_przydzielonego_pokoju",
  "rodzaj_depozytu",
  "typ_klienta")

inne <- c(
  "rok_przyjazdu",
  "dzieÅ„_przyjazdu_w_miesiÄ…cu",
  "status_rezerwacji",
  "data_statusu_rezerwacji",
  "agent_rezerwacji",
  "firma",
  "imiÄ™_i_nazwisko",
  "adres_email",
  "numer_telefonu",
  "numer_karty_kredytowej")

# 4. Tabela podsumowujÄ…ca
metadata <- tibble(
  zmienna = names(hotel),
  typ_danych = sapply(hotel, class),
  stymulanta_destymulanta = case_when(
    names(hotel) %in% stymulanty ~ "stymulanta",
    names(hotel) %in% destymulanty ~ "destymulanta",
    names(hotel) %in% nominanty ~ "nominanta",
    names(hotel) %in% inne ~ "inne",
    TRUE ~ "zmienna objaÅ›niana")) %>%
  mutate(kolejnosc = case_when(
    stymulanta_destymulanta == "zmienna objaÅ›niana" ~ 1,
    stymulanta_destymulanta == "stymulanta" ~ 2,
    stymulanta_destymulanta == "destymulanta" ~ 3,
    stymulanta_destymulanta == "nominanta" ~ 4,
    TRUE ~ 5)) %>%
  arrange(kolejnosc, zmienna) %>%
  select(-kolejnosc)

metadata %>%
  datatable(
    rownames = FALSE,
    options = list(pageLength = 15),
    class = "stripe hover") %>%
  formatStyle(
    "stymulanta_destymulanta",
    backgroundColor = styleEqual(
      c("zmienna objaÅ›niana", "stymulanta", "destymulanta", "nominanta", "inne"),
      c("#d1e7dd", "#e7f1ff", "#f8d7da", "#fff3cd", "#e2e3e5")))
```

## 1.4. Identyfikacja zmiennych binarnych

```{r zmienne binarne, echo=FALSE}
is_binary <- function(x) {
  is.numeric(x) && all(na.omit(x) %in% c(0,1))
}

binarne <- sapply(hotel, is_binary)

data.frame(
  check.names = FALSE,
  "Zmienne binarne:" = paste(names(binarne[binarne]), collapse = ", "),
  stringsAsFactors = FALSE) %>%
  datatable(rowname = FALSE, options = list(paging = FALSE, dom = 't'))
```

::: {style="text-align: justify;"}
W zbiorze pznajdujÄ… siÄ™ dwie zmienne binarne: zmienna objaÅ›niana -
*odwoÅ‚anie_rezerwacji* oraz zmienna objaÅ›niajÄ…ca *powracajÄ…cy_goÅ›Ä‡*.
:::

# 2. Analiza eksploracyjna danych

## 2.1. Podstawowe statystyki opisowe

```{r statystyki, echo=FALSE}
# 1. Lista zmiennych
zmienne_ilosciowe <- c(
  "wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane",
  "liczba_specjalnych_prÃ³Å›b",
  "liczba_nocy_weekendowych",
  "liczba_nocy_tygodniowych",
  "liczba_dorosÅ‚ych",
  "liczba_dzieci",
  "liczba_niemowlÄ…t",
  "wymagane_miejsca_parkingowe",
  "czas_wyprzedzenia_rezerwacji",
  "wczeÅ›niejsze_odwoÅ‚ania",
  "liczba_zmian_rezerwacji",
  "liczba_dni_na_liÅ›cie_oczekujÄ…cych",
  "Å›rednia_cena_za_noc")

zmienne_kategoryczne <- c(
  "typ_hotelu",
  "rodzaj_wyÅ¼ywienia",
  "segment_rynku",
  "kanaÅ‚_dystrybucji",
  "rodzaj_zarezerwowanego_pokoju",
  "rodzaj_przydzielonego_pokoju",
  "rodzaj_depozytu",
  "typ_klienta",
  "miesiÄ…c_przyjazdu",
  "numer_tygodnia_przyjazdu",
  "rok_przyjazdu",
  "dzieÅ„_przyjazdu_w_miesiÄ…cu",
  "status_rezerwacji")

zmienne_binarne <- c(
   "odwoÅ‚anie_rezerwacji",
   "powracajÄ…cy_goÅ›Ä‡"  )

# 2. Statystyki opisowe dla zmiennych iloÅ›ciowych
ilosciowe_tbl <- data.frame(
  zmienna = as.character(zmienne_ilosciowe),
  min = sapply(hotel[zmienne_ilosciowe], function(x) min(x, na.rm = TRUE)),
  max = sapply(hotel[zmienne_ilosciowe], function(x) max(x, na.rm = TRUE)),
  Å›rednia = round(sapply(hotel[zmienne_ilosciowe], function(x) mean(x, na.rm = TRUE)), 2),
  sd = round(sapply(hotel[zmienne_ilosciowe], function(x) sd(x, na.rm = TRUE)), 2),
  Q1 = sapply(hotel[zmienne_ilosciowe], function(x) quantile(x, 0.25, na.rm = TRUE)),
  mediana = sapply(hotel[zmienne_ilosciowe], function(x) median(x, na.rm = TRUE)),
  Q3 = sapply(hotel[zmienne_ilosciowe], function(x) quantile(x, 0.75, na.rm = TRUE)),
  row.names = NULL)

# 3. Statystyki opisowe dla zmiennych binarnych
binarne_tbl <- data.frame(
  zmienna = as.character(zmienne_binarne),
  min = 0,
  max = 1,
  Å›rednia = round(sapply(hotel[binarne], function(x) mean(x, na.rm = TRUE)), 2),
  sd = round(sapply(hotel[binarne], function(x) sd(x, na.rm = TRUE)), 2),
  Procent_1 = paste0(round(sapply(hotel[binarne], function(x) mean(x, na.rm = TRUE)*100), 2), "%"),
  row.names = NULL)

# 4. Statystyki opisowe dla zmiennych kategorycznych
categorical_summary <- function(df, vars) {
  res <- data.frame()
  for(v in vars) {
    tbl <- table(df[[v]])
    tbl <- sort(tbl, decreasing = TRUE)
    top_values <- paste(names(tbl)[1:min(3, length(tbl))], collapse = ", ")
    top_pct <- paste(round(prop.table(tbl[1:min(3, length(tbl))])*100, 2)[1:min(3, length(tbl))], collapse = "%, ")
    tmp <- data.frame(
      zmienna = as.character(v),
      NajczÄ™stsze = paste0(top_values, " (", top_pct, "%)")
    )
    res <- rbind(res, tmp)
  }
  return(res)
}

kategoryczne_tbl <- categorical_summary(hotel, zmienne_kategoryczne)

# 5. WyÅ›wietlenie tabel
ilosciowe_tbl %>%
  datatable(caption = "Zmienne iloÅ›ciowe", rownames = FALSE, options = list(paging = FALSE))

binarne_tbl %>%
  datatable(caption = "Zmienne binarne", rownames = FALSE, options = list(paging = FALSE))

kategoryczne_tbl %>%
  datatable(caption = "Zmienne kategoryczne", rownames = FALSE, options = list(paging = FALSE))


###### Propozycja obliczania i wyÅ›wietlania statystyk "NajczÄ™stszych" dla zmiennych kategorycznych
categorical_summary <- function(df, vars, top_n = 3) {
  res <- list()

  for (v in vars) {
    tbl <- sort(table(df[[v]]), decreasing = TRUE)
    pct <- round(prop.table(tbl) * 100, 2)

    out <- data.frame(
      zmienna = v,
      Top1 = names(tbl)[1],
      Top1_pct = paste0(round(pct[1], 1), "%"),
      Top2 = ifelse(length(tbl) >= 2, names(tbl)[2], NA),
      Top2_pct = ifelse(length(tbl) >= 2, paste0(round(pct[2], 1), "%"), NA),
      Top3 = ifelse(length(tbl) >= 3, names(tbl)[3], NA),
      Top3_pct = ifelse(length(tbl) >= 3, paste0(round(pct[3], 1), "%"), NA))

    res[[v]] <- out
  }

  bind_rows(res)
}

kategoryczne_tbl <- categorical_summary(hotel, zmienne_kategoryczne)

kategoryczne_tbl %>%
  rename_with(~ c("%_Top1","%_Top2","%_Top3"), .cols = c(Top1_pct, Top2_pct, Top3_pct)) %>%
  datatable(caption = "Zmienne kategoryczne", rownames = FALSE, options = list(paging = FALSE, columnDefs = list(list(className = 'dt-center', targets = 1:6))))
        
######
```

::: {style="text-align: justify;"}
Przeprowadzono analizÄ™ statystycznÄ… zmiennych iloÅ›ciowych, binarnych
oraz kategorycznych. 

**Zmienne iloÅ›ciowe** opisano za pomocÄ… nastÄ™pujÄ…cych statystyk: 
wartoÅ›Ä‡ minimalna i maksymalna, Å›rednia, odchylenie standardowe oraz
kwantyle 1, 2 (mediana) i 3. NiepokojÄ…ca jest ujemna wartoÅ›Ä‡ 
*Å›redniej ceny za noc*, ktÃ³rÄ… poddano dodatkowej analizie w kolejnych 
etapach przetwarzania danych.

W zbiorze znajdujÄ… siÄ™ rÃ³wnieÅ¼ dwie **zmienne binarne**: zmienna
objaÅ›niana *odwoÅ‚anie_rezerwacji* oraz zmienna objaÅ›niajÄ…ca
*powracajÄ…cy_goÅ›Ä‡*. Kolumna Procent_1 przedstawia odsetek obserwacji, w
ktÃ³rych zmienna przyjmuje wartoÅ›Ä‡ 1, co pozwala na wyciÄ…gniÄ™cie
pierwszych istotnych wnioskÃ³w.

**Zmienne kategoryczne** opisano pod wzglÄ™dem najczÄ™Å›ciej wystÄ™pujÄ…cych
wartoÅ›ci wraz z ich udziaÅ‚em w caÅ‚ym zbiorze.


TU TRZEBABY DODAÄ† JESZCZE FAKTYCZNY OPIS TYCH STATYSTYK (CHYBA)
:::

## 2.2. Analiza rozkÅ‚adÃ³w

### 2.2.1. Histogramy dla zmiennych iloÅ›ciowych w postaci logarytmicznej

```{r histogramy iloÅ›ciowe log, echo=FALSE, message=FALSE, warning=FALSE}
logarytm <- c("wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane",
              "liczba_dzieci",
              "liczba_niemowlÄ…t",
              "wymagane_miejsca_parkingowe",
              "wczeÅ›niejsze_odwoÅ‚ania",
              "liczba_zmian_rezerwacji",
              "liczba_dni_na_liÅ›cie_oczekujÄ…cych")

for (var in logarytm) {
  range_var <- max(hotel[[var]], na.rm = TRUE) - min(hotel[[var]], na.rm = TRUE)
  binwidth <- max(1, range_var / 30)
  
  p <- ggplot(hotel, aes(x = .data[[var]])) +
    geom_histogram(aes(y = after_stat(count) + 1),  # dodajemy 1, Å¼eby log(0) nie byÅ‚o
                   fill = "#21908d", color = "white", binwidth = binwidth) +
    scale_y_log10() +
    labs(x = var,
         y = "Liczba obserwacji (log)",
         title = paste("Histogram:", var)) +
    theme_minimal()
  
  print(p)
}
```

::: {style="text-align: justify;"}
Histogramy zmiennych iloÅ›ciowych zaprezentowano z wykorzystaniem
logarytmicznej osi OY, co pozwoliÅ‚o odsÅ‚oniÄ‡ strukturÄ™ rozkÅ‚adÃ³w
niewidocznÄ… przy klasycznej skali. Wynika to z faktu, Å¼e we wszystkich
przypadkach zdecydowanie dominuje wartoÅ›Ä‡ â€0â€, skutecznie maskujÄ…ca
zrÃ³Å¼nicowanie pozostaÅ‚ych obserwacji. 

RozkÅ‚ady zmiennych *liczba_dzieci*, *liczba_niemowlÄ…t* oraz *wymagane_miejsca_parkingowe*
charakteryzujÄ… siÄ™ wyraÅºnym skupieniem obserwacji w dolnym zakresie oraz
obecnoÅ›ciÄ… wartoÅ›ci skrajnych (np. 10 dzieci w jednej obserwacji), ktÃ³re
zostanÄ… odpowiednio przeksztaÅ‚cone w dalszej czÄ™Å›ci analizy. Z kolei
zmienne *wczeÅ›niejsze_rezerwacje nieodwoÅ‚ane*, *liczba_zmian_rezerwacji*
oraz *liczba_dni_na_liÅ›cie_oczekujÄ…cych* wykazujÄ… mniejsze
zrÃ³Å¼nicowanie - odchylenia od wartoÅ›ci centralnych sÄ… ograniczone, a
rozkÅ‚ady pozostajÄ… bardziej zwarte. Zmienna *wczeÅ›niejsze_odwoÅ‚ania*
charakteryzuje siÄ™ nieregularnym, â€poszarpanymâ€ przebiegiem, co utrudnia
jednoznacznÄ… identyfikacjÄ™ jej rozkÅ‚adu. Mimo to, podobnie jak w
przypadku pozostaÅ‚ych analizowanych zmiennych, najwiÄ™ksze zagÄ™szczenie
obserwacji wystÄ™puje w dolnym zakresie wartoÅ›ci. WspÃ³lnÄ… cechÄ…
wszystkich analizowanych zmiennych jest asymetria prawostronna, co
wskazuje na obecnoÅ›Ä‡ nielicznych, lecz istotnych obserwacji o wyÅ¼szych
wartoÅ›ciach.
:::

### 2.2.2. Histogramy dla pozostaÅ‚ych zmiennych iloÅ›ciowych

```{r histogramy iloÅ›ciowe, echo=FALSE}
iloscowe <- c("liczba_specjalnych_prÃ³Å›b",
              "liczba_nocy_weekendowych",
              "liczba_nocy_tygodniowych",
              "liczba_dorosÅ‚ych",
              "czas_wyprzedzenia_rezerwacji")

for (var in iloscowe) {
  range_var <- max(hotel[[var]], na.rm = TRUE) - min(hotel[[var]], na.rm = TRUE)
  binwidth <- range_var / 30
  
  q <- ggplot(hotel, aes(x = .data[[var]])) +
    geom_histogram(fill = "steelblue", color = "white", binwidth = binwidth) +
    labs(x = var,
         y = "CzÄ™stoÅ›Ä‡",
         title = paste("Histogram:", var)) +
    theme_minimal()
  
  print(q)
}
```

::: {style="text-align: justify;"}
Analizowane piÄ™Ä‡ zmiennych liczbowych wykazuje wyraÅºnie zrÃ³Å¼nicowane
ksztaÅ‚ty rozkÅ‚adÃ³w, co widaÄ‡ na przygotowanych histogramach. W kaÅ¼dej z
nich obserwacje koncentrujÄ… siÄ™ gÅ‚Ã³wnie przy niskich wartoÅ›ciach, jednak
tylko zmienna *czas_wyprzedzenia_rezerwacji* prezentuje typowy rozkÅ‚ad
prawoskoÅ›ny, wskazujÄ…c, Å¼e wiÄ™kszoÅ›Ä‡ rezerwacji dokonywana jest z
niewielkim wyprzedzeniem, przy jednoczesnym istnieniu nielicznych,
bardzo odlegÅ‚ych terminÃ³w. W przypadku zmiennej
*liczba_nocy_tygodniowych* rozkÅ‚ad jest zbliÅ¼ony do normalnego, co
sugeruje rÃ³wnomierne rozÅ‚oÅ¼enie dÅ‚ugoÅ›ci pobytÃ³w tygodniowych wokÃ³Å‚
wartoÅ›ci Å›redniej. PozostaÅ‚e trzy zmienne - *liczba_specjalnych_prÃ³Å›b*,
*liczba_nocy_weekendowych* oraz *liczba_dorosÅ‚ych* - nie wykazujÄ…
jednoznacznych, charakterystycznych form rozkÅ‚adu. Histogramy pokazujÄ…
ich nieregularne, niejednorodne rozmieszczenie, z niewielkimi
skupieniami w dolnym zakresie i obecnoÅ›ciÄ… wartoÅ›ci odstajÄ…cych. Analiza
wizualna tych wykresÃ³w pozwala zidentyfikowaÄ‡ zarÃ³wno typowe zachowania,
jak i obserwacje nietypowe, ktÃ³re mogÄ… wymagaÄ‡ uwzglÄ™dnienia przy
dalszej modelowej analizie.
:::

### 2.2.3. Histogramy dla zmiennych kategorycznych

```{r histogramy kategoryczne, echo=FALSE}
for (var in c(zmienne_kategoryczne)) {
  if (!var %in% names(hotel)) next
  x <- hotel[[var]]
  if (all(is.na(x))) next
  
  ggplot(hotel, aes(x = .data[[var]])) +
    geom_bar(
      fill = "#21908d",
      color = "white",
      width = 0.7,    # ğŸ”¹ gruboÅ›Ä‡ sÅ‚upkÃ³w
      na.rm = TRUE
    ) +
    labs(title = var, x = "Kategoria", y = "Liczba obserwacji") +
    theme_minimal(base_size = 12) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      strip.text = element_text(face = "bold"),
      panel.grid.major = element_line(color = "#eeeeee"),
      panel.grid.minor = element_blank()
    ) -> w
  print(w)
}
```

::: {style="text-align:justify;"}
Wykresy rozkÅ‚adÃ³w zmiennych kategorycznych pozwoliÅ‚y przyjrzeÄ‡ siÄ™
strukturze danych, wskazaÄ‡ dominujÄ…ce kategorie oraz wstÄ™pnie oceniÄ‡
zmienne potencjalnie wpÅ‚ywajÄ…ce na *odwoÅ‚anie_rezerwacji.* Na podstawie
wizualizacji moÅ¼na zauwaÅ¼yÄ‡, Å¼e najwiÄ™ksze zrÃ³Å¼nicowanie udziaÅ‚u odwoÅ‚aÅ„
wystÄ™puje w przypadku zmiennej *rodzaj_depozytu*, co sugeruje jej
kluczowÄ… rolÄ™ w dalszej analizie. WyraÅºne rÃ³Å¼nice miÄ™dzy kategoriami
widaÄ‡ rÃ³wnieÅ¼ w zmiennych *segment_rynku*, *kanaÅ‚_dystrybucji* oraz
*typ_klienta*, co odzwierciedla rÃ³Å¼ne profile klientÃ³w i sposoby
dokonywania rezerwacji. Zmienne takie jak *rodzaj_wyÅ¼ywienia* i
*typ_hotelu* rÃ³wnieÅ¼ wykazujÄ… dominacjÄ™ niektÃ³rych kategorii; choÄ‡ same
w sobie nie decydujÄ… bezpoÅ›rednio o odwoÅ‚aniach, mogÄ… wspomagaÄ‡ analizÄ™
w poÅ‚Ä…czeniu z innymi cechami, np. cenÄ… czy dÅ‚ugoÅ›ciÄ… pobytu. Wykresy
zmiennych czasowych, *miesiÄ…c_przyjazdu* i *numer_tygodnia_przyjazdu*,
pokazujÄ… okresy planowanych pobytÃ³w i pozwalajÄ… uchwyciÄ‡ sezonowe wzorce
rezerwacji, ktÃ³re mogÄ… poÅ›rednio wpÅ‚ywaÄ‡ na czÄ™stoÅ›Ä‡ anulowaÅ„. Na tej
podstawie zmienne *rodzaj_depozytu*, *segment_rynku*,
*kanaÅ‚_dystrybucji*, *typ_klienta*, a takÅ¼e *miesiÄ…c_przyjazdu* i
*numer_tygodnia_przyjazdu* wydajÄ… siÄ™ najbardziej wartoÅ›ciowe do dalszej
analizy.
:::

::: {style="text-align:justify;"}
Analiza wykresÃ³w rozkÅ‚adÃ³w zmiennych liczbowych i kategorycznych
pozwoliÅ‚a poznaÄ‡ strukturÄ™ danych i zidentyfikowaÄ‡ obserwacje odstajÄ…ce.
W zmiennych liczbowych dominujÄ… niskie wartoÅ›ci, a niektÃ³re, jak
*czas_wyprzedzenia_rezerwacji* czy *liczba_nocy_tygodniowych*, wykazujÄ…
wyraÅºne ksztaÅ‚ty rozkÅ‚adu. WÅ›rÃ³d zmiennych kategorycznych najwiÄ™ksze
rÃ³Å¼nice w udziale odwoÅ‚aÅ„ wystÄ™pujÄ… w *rodzaj_depozytu*,
*segment_rynku*, *kanaÅ‚_dystrybucji* i *typ_klienta*, natomiast
*rodzaj_wyÅ¼ywienia*, *typ_hotelu* oraz zmienne czasowe mogÄ… peÅ‚niÄ‡ rolÄ™
wspomagajÄ…cÄ…. Wnioski z wykresÃ³w wskazujÄ…, ktÃ³re cechy warto uwzglÄ™dniÄ‡
w dalszej analizie *odwoÅ‚ania_rezerwacji*.
:::

## 2.3. Analiza korelacji

::: {style="text-align:justify;"}
AnalizÄ™ korelacji przeprowadzono dla nastÄ™pujÄ…cych zmiennych iloÅ›ciowych
oraz dla zmiennej objaÅ›nianej:

1.  wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane,
2.  liczba_specjalnych_prÃ³Å›b,
3.  liczba_nocy_weekendowych,
4.  liczba_nocy_tygodniowych,
5.  liczba_dorosÅ‚ych,
6.  liczba_dzieci,
7.  liczba_niemowlÄ…t,
8.  wymagane_miejsca_parkingowe,
9.  czas_wyprzedzenia_rezerwacji,
10. wczeÅ›niejsze_odwoÅ‚ania,
11. liczba_zmian_rezerwacji,
12. liczba_dni_na_liÅ›cie_oczekujÄ…cych,
13. Å›rednia_cena_za_noc,
14. powracajÄ…cy_goÅ›Ä‡,
15. odwoÅ‚anie_rezerwacji.
:::

```{r korelacja, echo=FALSE}
hotelkorr <- hotel %>%
  rename(
  "1" = "wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane",
  "2" = "liczba_specjalnych_prÃ³Å›b",
  "3" = "liczba_nocy_weekendowych",
  "4" = "liczba_nocy_tygodniowych",
  "5" = "liczba_dorosÅ‚ych",
  "6" = "liczba_dzieci",
  "7" = "liczba_niemowlÄ…t",
  "8" = "wymagane_miejsca_parkingowe",
  "9" = "czas_wyprzedzenia_rezerwacji",
  "10" = "wczeÅ›niejsze_odwoÅ‚ania",
  "11" = "liczba_zmian_rezerwacji",
  "12" = "liczba_dni_na_liÅ›cie_oczekujÄ…cych",
  "13" = "Å›rednia_cena_za_noc",
  "14" = "powracajÄ…cy_goÅ›Ä‡",
  "15" = "odwoÅ‚anie_rezerwacji"
)

zmienne_i <- c(
  "1",
  "2",
  "3",
  "4",
  "5",
  "6",
  "7",
  "8",
  "9",
  "10",
  "11",
  "12",
  "13",
  "14",
  "15"
)

# 1. MACIERZ KORELACJI PEARSONA
hotel_num <- hotelkorr[, zmienne_i]
macierz_korelacji <- cor(hotel_num,
                         method = "pearson",
                         use = "pairwise.complete.obs"
)

# 1.2. WIZUALIZACJA MACIERZY KORELACJI
corrplot(macierz_korelacji, 
         method = "circle", 
         type = "upper",
         title = "Macierz korelacji - metoda kÃ³Å‚ek",
         mar = c(0,0,1,0))
```

::: {style="text-align: justify;"}
Åatwo zauwaÅ¼yÄ‡, Å¼e wÅ›rÃ³d analizowanych zmiennych nie wystÄ™puje wiele
silnych zaleÅ¼noÅ›ci. NajwiÄ™kszÄ… zaleÅ¼noÅ›Ä‡ dodatniÄ… widaÄ‡ miÄ™dzy *liczbÄ…
nocy weekendowych* oraz *liczbÄ… nocy tygodniowych*. Z kolei najbardziej
zauwaÅ¼alna zaleÅ¼noÅ›Ä‡ ujemna wystÄ™puje miÄ™dzy *liczbÄ… specjalnych prÃ³Å›b*
a *zmiennÄ… objaÅ›nianÄ…*. Kolejne zauwaÅ¼alne relacje wystÄ™pujÄ… gÅ‚Ã³wnie
przy zmiennej objaÅ›nianej. PoniÅ¼ej przeprowadzono szczegÃ³Å‚owÄ… analizÄ™
korelacji.
:::

### 2.3.1. Testy istotnoÅ›ci korelacji

```{r istotnoÅ›Ä‡ korelacji, echo=FALSE}
cat("\n2. TESTY ISTOTNOÅšCI KORELACJI:\n")
cat("\n2.1. Test istotnoÅ›ci korelacji zmiennych liczba nocy weekendowych oraz liczba nocy tygodniowych:\n")
cor_test_results2 <- cor.test(hotel$liczba_nocy_weekendowych, hotel$liczba_nocy_tygodniowych)
cat("r =", round(cor_test_results2$estimate, 3), "\n")
cat("p-value =", round(cor_test_results2$p.value, 5), "\n")

cat("\n2.2. Test istotnoÅ›ci korelacji zmiennych liczba specjalnych prÃ³Å›b oraz odwoÅ‚anie rezerwacji:\n")
cor_test_results2 <- cor.test(hotel$liczba_specjalnych_prÃ³Å›b, hotel$odwoÅ‚anie_rezerwacji)
cat("r =", round(cor_test_results2$estimate, 3), "\n")
cat("p-value =", round(cor_test_results2$p.value, 5), "\n")

cat("\n2.3. Test istotnoÅ›ci korelacji zmiennych wymagane miejsca parkingowe oraz odwoÅ‚anie rezerwacji:\n")
cor_test_results2 <- cor.test(hotel$wymagane_miejsca_parkingowe, hotel$odwoÅ‚anie_rezerwacji)
cat("r =", round(cor_test_results2$estimate, 3), "\n")
cat("p-value =", round(cor_test_results2$p.value, 5), "\n")

cat("\n2.4. Test istotnoÅ›ci korelacji zmiennych czas wyprzedzenia rezerwacji oraz odwoÅ‚anie rezerwacji:\n")
cor_test_results2 <- cor.test(hotel$czas_wyprzedzenia_rezerwacji, hotel$odwoÅ‚anie_rezerwacji)
cat("r =", round(cor_test_results2$estimate, 3), "\n")
cat("p-value =", round(cor_test_results2$p.value, 5), "\n")

cat("\n2.5. Test istotnoÅ›ci korelacji zmiennych wczeÅ›niejsze odwoÅ‚ania oraz odwoÅ‚anie rezerwacji:\n")
cor_test_results2 <- cor.test(hotel$wczeÅ›niejsze_odwoÅ‚ania, hotel$odwoÅ‚anie_rezerwacji)
cat("r =", round(cor_test_results2$estimate, 3), "\n")
cat("p-value =", round(cor_test_results2$p.value, 5), "\n")

cat("\n2.6. Test istotnoÅ›ci korelacji zmiennych liczba zmian rezerwacji oraz odwoÅ‚anie rezerwacji:\n")
cor_test_results2 <- cor.test(hotel$liczba_zmian_rezerwacji, hotel$odwoÅ‚anie_rezerwacji)
cat("r =", round(cor_test_results2$estimate, 3), "\n")
cat("p-value =", round(cor_test_results2$p.value, 5), "\n")

cat("\n2.7. Test istotnoÅ›ci korelacji zmiennych powracajÄ…cy_goÅ›Ä‡, oraz odwoÅ‚anie rezerwacji:\n")
cor_test_results2 <- cor.test(hotel$powracajÄ…cy_goÅ›Ä‡, hotel$odwoÅ‚anie_rezerwacji)
cat("r =", round(cor_test_results2$estimate, 3), "\n")
cat("p-value =", round(cor_test_results2$p.value, 5), "\n")
```

1. Test istotnoÅ›ci korelacji zmiennych *liczba_nocy_weekendowych* oraz *liczba_nocy_tygodniowych*:
```{r testy istotnoÅ›ci korelacji 1, include=FALSE}
cor_test_results2 <- cor.test(hotel$liczba_nocy_weekendowych, hotel$liczba_nocy_tygodniowych)
```
r = `r round(cor_test_results2$estimate, 3)`
p-value = `r round(cor_test_results2$p.value, 5)`

2. Test istotnoÅ›ci korelacji zmiennych *liczba_specjalnych_prÃ³Å›b* oraz *odwoÅ‚anie_rezerwacji*:
```{r testy istotnoÅ›ci korelacji 2, include=FALSE}
cor_test_results2 <- cor.test(hotel$liczba_specjalnych_prÃ³Å›b, hotel$odwoÅ‚anie_rezerwacji)
```
r = `r round(cor_test_results2$estimate, 3)`
p-value = `r round(cor_test_results2$p.value, 5)`

3. Test istotnoÅ›ci korelacji zmiennych *wymagane_miejsca_parkingowe* oraz *odwoÅ‚anie_rezerwacji*:
```{r testy istotnoÅ›ci korelacji 3, include=FALSE}
cor_test_results2 <- cor.test(hotel$wymagane_miejsca_parkingowe, hotel$odwoÅ‚anie_rezerwacji)
```
r = `r round(cor_test_results2$estimate, 3)`
p-value = `r round(cor_test_results2$p.value, 5)`

4. Test istotnoÅ›ci korelacji zmiennych *czas_wyprzedzenia_rezerwacji* oraz *odwoÅ‚anie_rezerwacji*:
```{r testy istotnoÅ›ci korelacji 4, include=FALSE}
cor_test_results2 <- cor.test(hotel$czas_wyprzedzenia_rezerwacji, hotel$odwoÅ‚anie_rezerwacji)
```
r = `r round(cor_test_results2$estimate, 3)`
p-value = `r round(cor_test_results2$p.value, 5)`

5. Test istotnoÅ›ci korelacji zmiennych *wczeÅ›niejsze_odwoÅ‚ania* oraz *odwoÅ‚anie_rezerwacji*:
```{r testy istotnoÅ›ci korelacji 5, include=FALSE}
cor_test_results2 <- cor.test(hotel$wczeÅ›niejsze_odwoÅ‚ania, hotel$odwoÅ‚anie_rezerwacji)
```
r = `r round(cor_test_results2$estimate, 3)`
p-value = `r round(cor_test_results2$p.value, 5)`

6. Test istotnoÅ›ci korelacji zmiennych *liczba_zmian_rezerwacji* oraz *odwoÅ‚anie_rezerwacji*:
```{r testy istotnoÅ›ci korelacji 6, include=FALSE}
cor_test_results2 <- cor.test(hotel$liczba_zmian_rezerwacji, hotel$odwoÅ‚anie_rezerwacji)
```
r = `r round(cor_test_results2$estimate, 3)`
p-value = `r round(cor_test_results2$p.value, 5)`

7. Test istotnoÅ›ci korelacji zmiennych *powracajÄ…cy_goÅ›Ä‡* oraz *odwoÅ‚anie_rezerwacji*:
```{r testy istotnoÅ›ci korelacji 7, include=FALSE}
cor_test_results2 <- cor.test(hotel$powracajÄ…cy_goÅ›Ä‡, hotel$odwoÅ‚anie_rezerwacji)
```
r = `r round(cor_test_results2$estimate, 3)`
p-value = `r round(cor_test_results2$p.value, 5)`


::: {style="text-align: justify;"}
Analiza korelacji wykazaÅ‚a, Å¼e wszystkie badane zaleÅ¼noÅ›ci sÄ… istotne
statystycznie (p \< 0,05), jednak w wiÄ™kszoÅ›ci przypadkÃ³w majÄ… one sÅ‚abÄ…
siÅ‚Ä™. NajsilniejszÄ…, umiarkowanÄ… dodatniÄ… korelacjÄ™ zaobserwowano
pomiÄ™dzy *liczbÄ… nocy weekendowych* i *tygodniowych* (r = 0,499). PozostaÅ‚e
zmienne wykazujÄ… jedynie sÅ‚abe lub bardzo sÅ‚abe zwiÄ…zki z odwoÅ‚aniem
rezerwacji, co oznacza, Å¼e choÄ‡ zaleÅ¼noÅ›ci te sÄ… statystycznie istotne,
ich znaczenie praktyczne jest ograniczone.
:::

## 2.4. Analiza brakÃ³w danych

```{r NA, echo=FALSE}
na_counts <- colSums(is.na(hotel))

na_tbl <- tibble(
  Zmienna = names(na_counts),
  Liczba_NA = na_counts)

datatable(
  na_tbl,
  rownames = FALSE,
  options = list(pageLength = 25, dom = 't'),
  class = "stripe hover") %>%
  formatStyle(
    "Liczba_NA",
    target = "row",
    backgroundColor = styleInterval(
      c(0),
      c("transparent", "#f8d7da")))
```

::: {style="text-align: justify;"}
Analiza brakÃ³w wykazaÅ‚a, Å¼e wystÄ™pujÄ… one w trzech zmiennych: 

- *liczba_dzieci* (4 braki), 

- *firma* (112 593 brakÃ³w), 

- *agent_rezerwacji* (16 340 brakÃ³w).

:::

```{r procent NA, echo=FALSE}
na_pct <- tibble(
  Zmienna = c("liczba_dzieci", "firma", "agent_rezerwacji"),
  Procent_NA = c(
    mean(is.na(hotel$liczba_dzieci)),
    mean(is.na(hotel$firma)),
    mean(is.na(hotel$agent_rezerwacji))
    ) * 100
  )

datatable(
  na_pct,
  rownames = FALSE,
  class = "stripe hover compact",
  options = list(pageLength = 5, dom = 't', paging = FALSE),
  caption = "Procent brakÃ³w danych (NA) dla wskazanych zmiennych") %>%
  formatRound("Procent_NA", 2)
```

::: {style="text-align: justify;"}
WartoÅ›ci NA stanowiÄ…:

- mniej niÅ¼ 1% obserwacji zmiennej *liczba_dzieci*, 

- blisko 100% wartoÅ›ci zmiennej *firma*, 

- niecaÅ‚e 14% obserwacji zmiennej *agent_rezerwacji*.

W dalszej czÄ™Å›ci pracy zostanie omÃ³wione podejÅ›cie do ich uzupeÅ‚nienia
oraz odpowiednia â€obrÃ³bkaâ€ brakÃ³w danych, uwzglÄ™dniajÄ…ca charakter
poszczegÃ³lnych zmiennych i wpÅ‚yw na analizÄ™.
:::

## 2.5. Analiza obserwacji odstajÄ…cych

::: {style="text-align: justify;"}
Analiza obserwacji odstajÄ…cych zostaÅ‚a przeprowadzona dla zmiennych
iloÅ›ciowych.
:::

### 2.5.1 Wykresy pudeÅ‚kowe

```{r boxplot, echo=FALSE, message=FALSE, warning=FALSE}
df_ilosciowe <- hotel %>% select(all_of(zmienne_ilosciowe))
boxplot(df_ilosciowe, main = "Analiza odchyleÅ„", las = 2)

##### PROPOZYCJA DLA WIZUALIZACJI WSTÄ˜PNEJ (ZE STANDARYZACJÄ„)
hotel %>%
  select(all_of(zmienne_ilosciowe)) %>%
  scale() %>%
  as.data.frame() %>%
  pivot_longer(
    everything(),
    names_to = "zmienna",
    values_to = "wartoÅ›Ä‡") %>%
  ggplot(aes(x = zmienna, y = wartoÅ›Ä‡)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = "Analiza odchyleÅ„ (standaryzacja Z-score)")
```

::: {style="text-align: justify;"}
OgÃ³lna analiza odchyleÅ„ przy wykorzystaniu boxplotÃ³w pokazuje, Å¼e sÄ…
zmienne, w ktÃ³rych wystÄ™pujÄ… wartoÅ›ci odstajÄ…ce. PoniÅ¼ej przeprowadzona
zostanie szczegÃ³Å‚owa analiza odchyleÅ„ za pomocÄ… wykresÃ³w
kwantyl-kwantyl.
:::

### 2.5.2. Wykresy kwantyl-kwantyl z okreÅ›leniem skoÅ›noÅ›ci i kurtozy

```{r Q-Q, echo=FALSE}
wrap_title <- function(title, width = 30) {
  paste(strwrap(title, width = width), collapse = "\n")
}

num_vars <- names(df_ilosciowe)
skew_values <- numeric(length(num_vars))
kurt_values <- numeric(length(num_vars))


par(mfrow = c(1,2), mar = c(8,4,4,2))

for (i in seq(1, length(num_vars), by = 2)) {
  for (j in 0:1) {
    idx <- i + j
    if (idx <= length(num_vars)) {
      x <- na.omit(df_ilosciowe[[idx]])
      var_name <- num_vars[idx]
      
      qqnorm(x, pch = 1, frame = FALSE, cex.main = 1, cex.lab = 0.8, cex.axis = 0.8, main = wrap_title(paste("QQ plot:", var_name)))
      qqline(x, col = "steelblue", lwd = 2)

            skew_values[idx] <- signif(skewness(x), 3)
      kurt_values[idx] <- signif(kurtosis(x), 3)
      
      mtext(paste0("skew = ", skew_values[idx]), side = 1, line = 5, cex.main = 0.9)
      mtext(paste0("kurt = ", kurt_values[idx]), side = 1, line = 6, cex.main = 0.9)
    }
  }
}
```

```{r Interpretacja wykresÃ³w kwantyl-kwantyl, echo=FALSE}
interpretacja <- c(
  "Skrajnie dodatnio skoÅ›ny rozkÅ‚ad z bardzo ciÄ™Å¼kim ogonem, wskazujÄ…cy na pojedyncze wartoÅ›ci ekstremalne.",
  "Lekko dodatnio skoÅ›ny rozkÅ‚ad, z niewielkim wpÅ‚ywem outlierÃ³w. RozkÅ‚ad umiarkowanie spiczasty.",
  "Dodatnia skoÅ›noÅ›Ä‡ z wyraÅºnie ciÄ™Å¼kimi ogonami. Pojedyncze rezerwacje o duÅ¼ej liczbie nocy wpÅ‚ywajÄ… na spiczastoÅ›Ä‡ rozkÅ‚adu.",
  "WyraÅºna dodatnia skoÅ›noÅ›Ä‡ i ciÄ™Å¼ki ogon, zmienna zawiera istotne outliery.",
  "Bardzo duÅ¼a dodatnia skoÅ›noÅ›Ä‡ i ekstremalnie spiczasty rozkÅ‚ad. Skrajne wartoÅ›ci znaczÄ…co wpÅ‚ywajÄ… na Å›redniÄ….",
  "ZnaczÄ…ca dodatnia skoÅ›noÅ›Ä‡ i ciÄ™Å¼kie ogony, pojedyncze wartoÅ›ci odstajÄ…ce.",
  "Skrajnie dodatnio skoÅ›ny i ekstremalnie spiczasty rozkÅ‚ad. WiÄ™kszoÅ›Ä‡ wartoÅ›ci to 0 lub 1, z pojedynczymi duÅ¼ymi wartoÅ›ciami.",
  "Dodatnia skoÅ›noÅ›Ä‡ i ciÄ™Å¼kie ogony; pojedyncze rezerwacje wymagajÄ… duÅ¼o miejsc parkingowych.",
  "Lekko dodatnio skoÅ›ny rozkÅ‚ad, umiarkowanie spiczasty. RozkÅ‚ad jest stosunkowo zbliÅ¼ony do normalnego, ale z kilkoma outlierami.",
  "Skrajna dodatnia skoÅ›noÅ›Ä‡ i spiczystoÅ›Ä‡; pojedyncze rezerwacje z wieloma odwoÅ‚aniami.",
  "Silnie dodatnio skoÅ›ny z wyraÅºnym wpÅ‚ywem outlierÃ³w.",
  "Bardzo dodatnia skoÅ›noÅ›Ä‡ i spiczastoÅ›Ä‡, pojedyncze rezerwacje oczekujÄ… bardzo dÅ‚ugo.",
  "Skrajnie dodatnia skoÅ›noÅ›Ä‡ i spiczastoÅ›Ä‡, obecnoÅ›Ä‡ bardzo drogich rezerwacji wypaczajÄ…cych Å›redniÄ…."
)

tabela_interp <- data.frame(
  Zmienna = num_vars,
  Skewness = skew_values,
  Kurtosis = kurt_values,
  Interpretacja = interpretacja,
  stringsAsFactors = FALSE
)

datatable(tabela_interp,
          rownames = FALSE,
          caption = "Analiza skoÅ›noÅ›ci i kurtozy zmiennych iloÅ›ciowych",
          options = list(paging = FALSE, columnDefs = list(list(className = 'dt-center', targets = 1:2))))
```

::: {style="text-align: justify;"}
Analiza rozkÅ‚adÃ³w zmiennych iloÅ›ciowych przy uÅ¼yciu boxplotÃ³w, a takÅ¼e
wartoÅ›ci *skoÅ›noÅ›ci* (skewness) i *kurtozy* (kurtosis) pozwoliÅ‚a
zidentyfikowaÄ‡ zmienne z odchyleniami i wartoÅ›ciami odstajÄ…cymi. Wysokie
wartoÅ›ci skewness wskazujÄ… na asymetriÄ™ rozkÅ‚adu, a wysokie wartoÅ›ci
kurtosis â€“ na spiczastoÅ›Ä‡ i ciÄ™Å¼kie ogony. W takich przypadkach lepszÄ…
miarÄ… tendencji centralnej niÅ¼ Å›rednia jest mediana. SzczegÃ³Å‚owe
interpretacje dla kaÅ¼dej zmiennej znajdujÄ… siÄ™ w powyÅ¼szej tabeli.
:::

### 2.5.3. Wielowymiarowa analiza odchyleÅ„ wzglÄ™dem zmiennej objaÅ›nianej

::: {style="text-align: justify;"}
W kolejnym kroku przeprowadzono wielowymiarowÄ… analizÄ™ odchyleÅ„ z
wykorzystaniem relacji miÄ™dzy zmiennÄ… objaÅ›nianÄ… *odwoÅ‚anie rezerwacji*
a zmiennymi objaÅ›niajÄ…cymi.
:::
```{r wielowymiarowa ao, echo=FALSE}
layout(matrix(c(1, 2), nrow = TRUE, byrow = 2), heights = c(4, 1, 1))

for (var in zmienne_ilosciowe) {
  # Tworzymy formuÅ‚Ä™ dynamicznie
  f <- as.formula(paste("odwoÅ‚anie_rezerwacji ~", var))
  
  # Dopasowujemy model liniowy
  fit <- lm(f, data = hotel)
  
  # Wykres diagnostyczny Cooka
  plot(fit, which = 4,  cex = 0.6, cex.main = 1, cex.lab = 0.8, cex.axis = 0.8, main = paste("OdwoÅ‚anie rezerwacji ~\n", var))
}
```

::: {style="text-align: justify;"}
Analiza odlegÅ‚oÅ›ci Cooka dla poszczegÃ³lnych zmiennych objaÅ›niajÄ…cych
wykazaÅ‚a zrÃ³Å¼nicowany stopieÅ„ wpÅ‚ywu obserwacji nietypowych na
stabilnoÅ›Ä‡ estymowanych parametrÃ³w modelu. SzczegÃ³lnÄ… uwagÄ™ naleÅ¼y
zwrÃ³ciÄ‡ na zmienne *liczba_dorosÅ‚ych* oraz *Å›rednia_cena_za_noc*, gdzie
zidentyfikowano punkty (m.in. nr 2174 oraz 48515) o ekstremalnie
wysokich wartoÅ›ciach statystyki $D$, siÄ™gajÄ…cych poziomu 0.8, co
wskazuje na ich krytyczny wpÅ‚yw na dopasowanie modelu. ZnaczÄ…ce wartoÅ›ci
odstajÄ…ce o charakterze punktÃ³w wpÅ‚ywowych widoczne sÄ… rÃ³wnieÅ¼ dla
zmiennych *liczba_niemowlÄ…t* (obserwacja 46620, $D \approx 0.3$) oraz
*wymagane_miejsca_parkingowe* (obserwacja 29046, $D \approx 0.15$).
Istotne zakÅ‚Ã³cenia odnotowano takÅ¼e w przypadku zmiennych
*wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane* oraz *liczba_zmian_rezerwacji*. W
pozostaÅ‚ych przypadkach, takich jak *liczba_specjalnych_prÃ³Å›b* czy *czas_wyprzedzenia_rezerwacji*, wartoÅ›ci odlegÅ‚oÅ›ci Cooka sÄ… rzÄ™du $10^{-3}$
lub mniejsze, co sugeruje brak dominujÄ…cych outlierÃ³w zaburzajÄ…cych
wyniki. W celu zapewnienia wiarygodnoÅ›ci prognoz i unikniÄ™cia biasu
wynikajÄ…cego z jednostkowych anomalii, rekomenduje siÄ™ usuniÄ™cie
obserwacji o najwyÅ¼szym wpÅ‚ywie z wyÅ¼ej wymienionych szeÅ›ciu zmiennych,
a nastÄ™pnie ponownÄ… kalibracjÄ™ modelu na oczyszczonym zbiorze danych.
:::

# 3. Czyszczenie danych

## 3.1. ObsÅ‚uga brakÃ³w wartoÅ›ci

### 3.1.1. Analiza wystÄ™powania brakÃ³w danych

PoniÅ¼ej przeprowdzono dokÅ‚adnÄ… analizÄ™ brakÃ³w danych w zmiennych *liczba_dzieci*, *agent_rezerwacji* oraz *firma*, majÄ…cÄ… na celu wskazanie dalszego postÄ™powania.

```{r obsÅ‚uga NA, echo=FALSE, message=FALSE, warning=FALSE}
hotel_miss <- hotel %>% select(liczba_dzieci, firma, agent_rezerwacji)
gg_miss_upset(hotel_miss)
```

::: {style="text-align: justify;"}
W celu dokÅ‚adniejszej analizy utworzono wykres UpSet, ktÃ³ry prezentuje wspÃ³Å‚wystÄ™powanie brakÃ³w miÄ™dzy zmiennymi. Wynika z niego, Å¼e:

- dla zmiennej *liczba_dzieci* wszystkie 4 braki wystÄ™pujÄ… wspÃ³Å‚zaleÅ¼nie: 2 braki z wartoÅ›ciami NA w zmiennej firma oraz 2 braki z brakami we wszystkich dwÃ³ch pozostaÅ‚ych analizowanych zmiennych;

- dla zmiennej *agent_rezerwacji* ok. 9,8 tys. brakÃ³w (ok. `r round(9758/16340*100, 2)`%) wystÄ™puje wspÃ³lnie z brakami w zmiennej firma, a 2 braki, jak juÅ¼ ustalono, wraz z brakami w pozostaÅ‚ych zmiennych. Natomiast blisko 6,6 tys. brakÃ³w (ok. `r round(6580/16340*100, 2)`%) wystÄ™puje niezaleÅ¼nie;

- w zmiennej *firma*, poza wskazanymi zaleÅ¼noÅ›ciami brakÃ³w, zdecydowana wiÄ™kszoÅ›Ä‡ wartoÅ›ci NA (ok. `r round(102831/112593*100, 2)`%) wystÄ™puje niezaleÅ¼nie.
:::


***Test MCAR***

*H0: * 
*HA: *

```{r test MCAR, echo=FALSE}
mcar_test(hotel_miss) %>%
  as.data.frame() %>% 
  mutate(statistic = round(statistic, 3)) %>%
  datatable(rownames = FALSE,
            caption = "Wyniki testu MCAR: Missing Completely At Random",
            options = list(dom = 't', paging = FALSE))
```

::: {style="text-align: justify;"}
Test Littleâ€™a dla brakÃ³w danych wykazaÅ‚ istotnoÅ›Ä‡ statystycznÄ… (Ï‡Â² =
633.62, df = 6, p \< 0.001), co pozwala odrzuciÄ‡ hipotezÄ™ zerowÄ… o
losowym wystÄ™powaniu brakÃ³w (MCAR). Oznacza to, Å¼e brakujÄ…ce wartoÅ›ci w
danych nie wystÄ™pujÄ… caÅ‚kowicie losowo i mogÄ… zaleÅ¼eÄ‡ od innych
zmiennych. W zwiÄ…zku z tym dalsza analiza wymaga zastosowania
odpowiednich metod radzenia sobie z brakami danych, takich jak imputacja
lub modele uwzglÄ™dniajÄ…ce ich obecnoÅ›Ä‡.
:::

### 3.1.2. Usuwanie brakÃ³w danych

::: {style="text-align: justify;"}
Na podstawie powyÅ¼szej analizy wysuniÄ™to nastÄ™pujÄ…ce wnioski:

- zmienna **lista_dzieci**

WartoÅ›ci NA wystÄ™pujÄ…ce w tej zmiennej stanowiÄ… marginalny odsetek obserwacji (0,003%). Ponadto, wspÃ³Å‚wystÄ™pujÄ… one z brakami w pozostaÅ‚ych analizowanych pod kÄ…dtem brakÃ³w zmiennych. Zaleca siÄ™ wobec tego usuniÄ™cie rekordÃ³w z brakami, bez stosowania imputacji.

- zmienna **agent_rezerwacji**

BrakujÄ…ce wartoÅ›ci zmiennej agent_rezerwacji stanowiÄ… 13,69% wartoÅ›ci tej zmiennej i sÄ… one w 59,72% wspÃ³Å‚zaleÅ¼ne z brakami w zmiennej firma. Wobec tego, zaleca siÄ™ zastosowanie prostej imputacji tych wartoÅ›ci Å›redniÄ… lub medianÄ… wartoÅ›ci tej zmiennej, bÄ…dÅº uzupeÅ‚nianie jej poprzez wielokrotnÄ… imputacjÄ™, np. przy pomocy pakietu "mice".
Z uwagi jednak na charakter i specyfikÄ™ wartoÅ›ci zmiennej agent_rezerwacji, tj. ID agencji podrÃ³Å¼y, ktÃ³ra dokonaÅ‚a rezerwacji, zasadnym uznano usuniÄ™cie tej zmiennej z dalszej analicy.

- zmienna **firma**

Braki w zmiennej firma, przez wzglÄ…d, iÅ¼ stanowiÄ… ponad 94% wszystkich wartoÅ›ci tej zmiennej, odbierajÄ… jej wartoÅ›Ä‡ informacyjnÄ…, wobec czego naleÅ¼y usunÄ…Ä‡ tÄ™ zmiennÄ….
:::

```{r Usuwanie brakÃ³w, include=FALSE}
hotel_noNA <- hotel %>%
  filter(!is.na(liczba_dzieci)) %>% # UsuniÄ™cie wierszy z brakami ze zmiennej liczba_dzieci
  select(-agent_rezerwacji, -firma) # Usuwanie zmiennych agent_rezerwacji oraz firma
```

```{r Sprawdzenie liczby NA po usuniÄ™ciu brakÃ³w, echo=FALSE}
na_counts2 <- colSums(is.na(hotel_noNA))

na_tbl2 <- tibble(
  Zmienna = names(na_counts2),
  Liczba_NA = na_counts2)

datatable(
  na_tbl2,
  rownames = FALSE,
  options = list(pageLength = 25, dom = 't'),
  caption = "Sprawdzenie liczby brakujÄ…cych wartoÅ›ci po usuniÄ™ciu ich ze zbioru danych",
  class = "stripe hover") %>%
  formatStyle(
    "Liczba_NA",
    target = "row",
    backgroundColor = styleInterval(
      c(0),
      c("transparent", "#f8d7da")))
```

Liczba obserwacji w zbiorze po usuniÄ™ciu brakÃ³w w zmiennej *liczba_dzieci*: **`r nrow(hotel_noNA)`**

Liczba zmiennych w zbiorze po usuniÄ™ciu zmiennej *agent_rezerwacji* oraz *firma*: **`r ncol(hotel_noNA)`**


## 3.2. ObsÅ‚uga obserwacji odstajÄ…cych

::: {style="text-align: justify;"}
W celu redukcji wartoÅ›ci odtsajÄ…cych zdecydowano siÄ™ na zastosowanie podejÅ›cia mieszanego. Na podstawie analizy boxplotÃ³w, miar skoÅ›noÅ›ci i kurtozy zidentyfikowano zmienne charakteryzujÄ…ce siÄ™ silnymi odchyleniami od symetrii oraz obecnoÅ›ciÄ… wartoÅ›ci ekstremalnych. Dodatkowo wykorzystano analizÄ™ odlegÅ‚oÅ›ci Cooka, ktÃ³ra pozwoliÅ‚a wskazaÄ‡ obserwacje silnie wpÅ‚ywowe, mogÄ…ce w istotny sposÃ³b zakÅ‚Ã³ciÄ‡ dalszÄ… analizÄ™ gÅ‚Ã³wnych skÅ‚adowych oraz analizÄ™ skupieÅ„, znanych z wysokiej wraÅ¼liwoÅ›ci na obserwacje odstajÄ…ce.
:::

### 3.2.1. UsuniÄ™cie wartoÅ›ci skrajnych

```{r UsuniÄ™cie wartoÅ›ci skrajnych, include=FALSE}
# UsuniÄ™cie obserwacji wpÅ‚ywowych (wg statystyki Cooka)
fit2 <- lm(f, data = hotel_noNA)
cook <- cooks.distance(fit2)
n <- nrow(hotel_noNA)
prog <- 4 / n

hotel_clean <- hotel_noNA[which(cook < prog), ]


# Sprawdzenie efektu przed i po usuniÄ™ciu wartoÅ›ci odstajÄ…cych
## liczba wierszy "przed"
n_before <- nrow(hotel_noNA)

## liczba wierszy "po"
n_after <- nrow(hotel_clean)

## liczba usuniÄ™tych obserwacji
removed <- n_before - n_after
```

::: {style="text-align: justify;"}
Aby ograniczyÄ‡ wpÅ‚yw obserwacji odstajÄ…cych na wariancjÄ™ i odlegÅ‚oÅ›ci miÄ™dzy obiektami, przed przeprowadzeniem analiz usuniÄ™to najbardziej wpÅ‚ywowe obserwacje, wyznaczone na podstawie statystyki Cooka, przyjmujÄ…c prÃ³g $4/n$.

W konsekwencji usuniÄ™to `r removed` obserwacji (`r round(removed/n_before*100, 2)`%) o najwyÅ¼szym wpÅ‚ywie na dopasowanie modelu.
:::

### 3.2.2. Winsoryzacja

::: {style="text-align: justify;"}
W kolejnym etapie rozwaÅ¼ono sposÃ³b ograniczenia wpÅ‚ywu wartoÅ›ci odstajÄ…cych w zmiennych iloÅ›ciowych o wysokiej skoÅ›noÅ›ci (skewness > 1). W dostosowywaniu winsonizacji uwzglÄ™dniono rÃ³wnieÅ¼ charakter zmiennych oraz ich potencjalny wpÅ‚yw na analizÄ™ gÅ‚Ã³wnych skÅ‚adowych (PCA) oraz analizÄ™ skupieÅ„.
:::

```{r Winsoryzacja wartoÅ›ci odstajÄ…cych w zmiennych o silnej skoÅ›noÅ›ci, echo=FALSE}
# Definiowanie funkcji
## IQR
winsorize_IQR <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  pmin(pmax(x, Q1 - 1.5 * IQR), Q3 + 1.5 * IQR)
}

## Precentyle
winsorize_p <- function(x) {
  p_low <- quantile(x, 0.01, na.rm = TRUE)
  p_high <- quantile(x, 0.99, na.rm = TRUE)
  pmin(pmax(x, p_low), p_high)
}


# WybÃ³r metody winsoryzacji
## Sprawdzenie najlepszej metody winsoryzacji na zmiennej o najwyÅ¼szej skoÅ›noÅ›ci
x <- hotel_noNA$Å›rednia_cena_za_noc

### IQR
x_iqr <- winsorize_IQR(x)

### Percentyle
p1 <- quantile(x, 0.01)
p99 <- quantile(x, 0.99)
x_p <- pmin(pmax(x, p1), p99)


# Winsoryzacja
## WybÃ³r zmiennych o duÅ¼ej skoÅ›noÅ›ci (>1)
skewed_vars <- num_vars[abs(skew_values) > 2]

## Dopasowanie nazw zmiennych do nazw ze zbioru hotel_noNA
skewed_vars <- skewed_vars[skewed_vars %in% names(hotel_noNA)]

## WyodrÄ™bnienie zmiennych ciÄ…gÅ‚ych, o duÅ¼ym zakresie
continuous_vars <- c("Å›rednia_cena_za_noc", "liczba_dni_na_liÅ›cie_oczekujÄ…cych")

## Sprawdzenie, czy wszystkie continuous_vars sÄ… w skewed_vars
continuous_vars <- continuous_vars[continuous_vars %in% skewed_vars]

## Winsoryzacja zmiennych continuous_vars
hotel_clean <- hotel_clean %>%
  mutate(across(all_of(continuous_vars), winsorize_p))
```

::: {style="text-align: justify;"}
Dla zmiennych o szerokim zakresie wartoÅ›ci i wyraÅºnych wartoÅ›ciach skrajnych (takich jak *Å›rednia_cena_za_noc* czy *liczba_dni_na_liÅ›cie_oczekujÄ…cych*), ktÃ³re mogÅ‚yby silnie wpÅ‚ywaÄ‡ na wariancjÄ™ i odlegÅ‚oÅ›ci pomiÄ™dzy obserwacjami, zastosowano winsoryzacjÄ™ opartÄ… na percentylach 1% i 99%. WybÃ³r tej metody byÅ‚ uzasadniony tym, Å¼e reguÅ‚a IQR prowadziÅ‚a do modyfikacji wiÄ™kszego odsetka danych (ok. `r round(mean(x != x_iqr) * 100, 2)`% w przypadku zmiennej o najwyÅ¼szej skoÅ›noÅ›ci spoÅ›rÃ³d wskazanych - tj. *Å›rednia_cena_za_noc* (skew = 10,5)), co przy tak duÅ¼ym zbiorze danych mogÅ‚oby prowadziÄ‡ do nadmiernego wygÅ‚adzenia rozkÅ‚adÃ³w.

Metoda percentylowa pozwoliÅ‚a ograniczyÄ‡ wpÅ‚yw najbardziej skrajnych obserwacji (ok. `r round(mean(x != x_p) * 100, 2)`% danych dla zmiennej o najwyÅ¼szym skewness), zachowujÄ…c jednoczeÅ›nie strukturÄ™ zmiennoÅ›ci istotnÄ… dla dalszych analiz wielowymiarowych. PozwoliÅ‚o to zmniejszyÄ‡ wpÅ‚yw ekstremÃ³w bez utraty istotnych obserwacji oraz uniknÄ…Ä‡ nadmiernÄ… modyfikacjÄ™ danych, charakterystycznÄ… dla reguÅ‚y IQR w przypadku rozkÅ‚adÃ³w silnie skoÅ›nych.
:::

### 3.2.3. Ograniczenie zmiennych "z gÃ³ry"

```{r obciÄ™cie gÃ³rnego ogona, echo=FALSE}
# WyodrÄ™bnienie zmiennych iloÅ›ciowych, dyskretnych, o niskiej rozpiÄ™toÅ›ci i wysokiej skoÅ›noÅ›ci
count_vars <- c("liczba_niemowlÄ…t", "liczba_zmian_rezerwacji", "wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane", "wczeÅ›niejsze_odwoÅ‚ania")

# Sprawdzenie, czy wszystkie count_vars sÄ… w skewed_vars
count_vars <- count_vars[count_vars %in% skewed_vars]

# Ograniczenie wybranych zmiennych "z gÃ³ry" odcinajÄ…c wartoÅ›ci odstajÄ…ce
hotel_clean <- hotel_clean %>%
  mutate(across(
    all_of(count_vars),
    ~ {
      p99 <- quantile(.x, 0.99, na.rm = TRUE)
      ifelse(.x > p99, p99, .x)
    }
  ))
```

::: {style="text-align: justify;"}
Zmienne takie, jak *liczba_niemowlÄ…t*, *liczba_zmian_rezerwacji*, *wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane* i *wczeÅ›niejsze_odwoÅ‚ania*, w ktÃ³rych zdecydowana wiÄ™kszoÅ›Ä‡ obserwacji przyjmowaÅ‚a wartoÅ›Ä‡ 0, nie zostaÅ‚y poddane klasycznej winsoryzacji percentylowej, poniewaÅ¼ mogÅ‚oby to prowadziÄ‡ do utraty informacji lub powstania wartoÅ›ci NA. W ich przypadku zastosowano jedynie kontrolowane ograniczenie najwyÅ¼szych wartoÅ›ci, co pozwoliÅ‚o zmniejszyÄ‡ wpÅ‚yw pojedynczych obserwacji skrajnych na analizÄ™ PCA i skupieÅ„, bez zmiany interpretacji tych zmiennych.
:::

### 3.2.4. Pozostawienie istotnych wartoÅ›ci odstajÄ…cych

:::  {style="text-align: justify;"}
PozostaÅ‚e zmienne o umiarkowanej skoÅ›noÅ›ci i niÅ¼szej statystyce Cooka (*liczba_dzieci*, *liczba_specjalnych_prÃ³Å›b*, *liczba_nocy_weekendowych*, *liczba_nocy_tygodniowych*, *liczba_dorosÅ‚ych*, *czas_wyprzedzenia_rezerwacji*, *wczeÅ›niejsze_odwoÅ‚ania*, *liczba_zmian_rezerwacji*, *wymagane_miejsca_parkingowe*), byÅ‚y poddane jedynie ograniczeniu wynikajÄ…cemu z ewentualnego przekroczenia progu $4/n$ dla statystyki Cooka ($D$). Przez wzglÄ…d na fakt, Å¼e ich wartoÅ›ci i zakres nie stwarzaÅ‚y jednak ryzyka nadmiernego wpÅ‚ywu pojedynczych obserwacji na analizÄ™ wielowymiarowÄ…, nie zastosowano dla nich innych, celowych modyfikacji majÄ…cych na celu spÅ‚aszczenie bÄ…dÅº ograniczenie zakresu ich wartoÅ›ci. DziÄ™ki temu zachowano maksymalnÄ… informacyjnoÅ›Ä‡ tych zmiennych, jednoczeÅ›nie minimalizujÄ…c wpÅ‚yw ekstremÃ³w w najbardziej krytycznych kolumnach.
:::

### 3.2.5. Podsumowanie wartoÅ›ci zmiennych po pszeksztaÅ‚ceniach

```{r Sprawdzanie obsÅ‚ugi wartoÅ›ci odstajÄ…cych 1, echo=FALSE}
# Boxploty zmiennych iloÅ›ciowych
vars_changed <- c(continuous_vars, count_vars, "liczba_dorosÅ‚ych")

for (var in vars_changed) {

  x_before <- hotel_noNA[[var]]
  x_after  <- hotel_clean[[var]]
  
  ## Boxplot "przed" obsÅ‚ugÄ… outlierÃ³w
  p1 <- ggplot(data.frame(Wartosc = x_before), aes(x = "", y = Wartosc)) +
    geom_boxplot(fill = "lightblue") +
    labs(title = "Przed") + 
    theme_minimal(base_size = 11) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 10),
      axis.title = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank())
  
  ## Boxplot "po" obrÃ³bce outlierÃ³w
  p2 <- ggplot(data.frame(Wartosc = x_after), aes(x = "", y = Wartosc)) +
    geom_boxplot(fill = "salmon") +
    labs(title = "Po") + 
    theme_minimal(base_size = 11) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 10),
      axis.title = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank())
  
  combined <- (p1 | p2) + 
    plot_annotation(title = var) +
    plot_layout(widths = c(1,1))
  
  print(combined)
}
```

opis

```{r Sprawdzanie obsÅ‚ugi wartoÅ›ci odstajÄ…cych 3, echo=FALSE}
# Statystyki "przed" i "po" przeksztaÅ‚ceniu zmiennych
ilosciowe_tbl %>%
  datatable(caption = "Zmienne iloÅ›ciowe (przed)", rownames = FALSE, options = list(paging = FALSE))

data.frame(
  zmienna = as.character(zmienne_ilosciowe),
  min = sapply(hotel_clean[zmienne_ilosciowe], function(x) min(x, na.rm = TRUE)),
  max = sapply(hotel_clean[zmienne_ilosciowe], function(x) max(x, na.rm = TRUE)),
  Å›rednia = round(sapply(hotel_clean[zmienne_ilosciowe], function(x) mean(x, na.rm = TRUE)), 2),
  sd = round(sapply(hotel_clean[zmienne_ilosciowe], function(x) sd(x, na.rm = TRUE)), 2),
  Q1 = sapply(hotel_clean[zmienne_ilosciowe], function(x) quantile(x, 0.25, na.rm = TRUE)),
  mediana = sapply(hotel_clean[zmienne_ilosciowe], function(x) median(x, na.rm = TRUE)),
  Q3 = sapply(hotel_clean[zmienne_ilosciowe], function(x) quantile(x, 0.75, na.rm = TRUE)),
  row.names = NULL) %>%
  datatable(caption = "Zmienne iloÅ›ciowe (po)", rownames = FALSE, options = list(paging = FALSE)) %>%
  formatStyle('zmienna', target = 'row', backgroundColor = styleEqual(vars_changed, rep('#d1e7dd', length(vars_changed))))
```

opis

```{r Sprawdzanie obsÅ‚ugi wartoÅ›ci odstajÄ…cych 2, echo=FALSE}
# Tabela podsumowujÄ…ca - skoÅ›noÅ›Ä‡ "przed" i "po" usuniÄ™ciu wartoÅ›ci odstajÄ…cych
skew_compare <- data.frame(
  skew_przed = round(
    sapply(
      hotel_noNA %>% select(all_of(zmienne_ilosciowe)),
      skewness,
      na.rm = TRUE), 2),
  skew_po = round(
    sapply(
      hotel_clean %>% select(all_of(zmienne_ilosciowe)),
      skewness,
      na.rm = TRUE), 2)) %>%
  mutate(poprawa = abs(skew_przed) - abs(skew_po))

skew_compare %>% 
  rename_with(~ c("poprawa_p.%"), .cols = c(poprawa)) %>% 
  datatable(
    options = list(pageLength = 25, dom = 't'),
    caption = "Sprawdzenie parametru skoÅ›noÅ›ci po obsÅ‚udze elementÃ³w odstajÄ…cych") %>%
  formatRound("poprawa_p.%", 2)
```

opis


# 4. ObrÃ³bka zmiennych
## 4.1. Tworzenie nowych zmiennych
:::  {style="text-align: justify;"}
Do zbioru dodano nowÄ… zmiennÄ… - *zmiana_pokoju*, ktÃ³ra sprawdza, czy rodzaj przydzielonego pokoju rÃ³Å¼niÅ‚ siÄ™ od pokoju pierwotnie zarezerwowanego przez klienta. Przyjmuje nastÄ™pujÄ…ce wartoÅ›ci:

- 1 (rodzaj pokoju zarezerwowanego rÃ³Å¼ni siÄ™ od przydzielonego)

- 0 (rodzaj pokoju pozostaÅ‚ bez zmian)

PoÅ‚Ä…czono takÅ¼e zmienne *liczba_nocy_weekendowych* oraz *liczba_nocy_tygodniowych* w celu utworzenia zmiennej o wiÄ™kszej sile informacyjnej - *liczba_nocy*, opisujÄ…cej Å‚Ä…cznÄ… dÅ‚ugoÅ›Ä‡ pobytu.

W podobnym celu powstaÅ‚a zmienna *liczba_osÃ³b* charakteryzujÄ…ca Å‚Ä…cznÄ… liczbÄ™ goÅ›ci, utworzonÄ… ze zmeinnych: *liczba_dorosÅ‚ych*, *liczba_dzieci* i *liczba_niemowlÄ…t*.
:::

```{r dodawanie zmiennych, echo=FALSE}
# Sprawdzenie czy pokÃ³j zostaÅ‚ zmieniony
hotel_clean$zmiana_pokoju <-
  ifelse(hotel_clean$rodzaj_zarezerwowanego_pokoju !=
         hotel_clean$rodzaj_przydzielonego_pokoju, 1, 0)

# ÅÄ…czna liczba zarezerwowanych nocy przez klienta
hotel_clean$liczba_nocy <-
  hotel_clean$liczba_nocy_weekendowych +
  hotel_clean$liczba_nocy_tygodniowych

# ÅÄ…czna liczba goÅ›ci
hotel_clean$liczba_osÃ³b <-
  hotel_clean$liczba_dorosÅ‚ych +
  hotel_clean$liczba_dzieci +
  hotel_clean$liczba_niemowlÄ…t

# SezonowoÅ›Ä‡ (lepsza niÅ¼ miesiÄ…c jako factor)
#hotel_clean$sezon <- factor(ifelse(
#  hotel_clean$miesiÄ…c_przyjazdu %in% c("June","July","August"), "wysoki",
#  ifelse(hotel_clean$miesiÄ…c_przyjazdu %in% c("December","January","February"),
#         "niski", "Å›redni")
#))

# Tabela statystyk nowych zmiennych
nowe_zmienne <- c("zmiana_pokoju", "liczba_nocy", "liczba_osÃ³b")

data.frame(
  zmienna = as.character(nowe_zmienne),
  min = sapply(hotel_clean[nowe_zmienne], function(x) min(x, na.rm = TRUE)),
  max = sapply(hotel_clean[nowe_zmienne], function(x) max(x, na.rm = TRUE)),
  Å›rednia = round(sapply(hotel_clean[nowe_zmienne], function(x) mean(x, na.rm = TRUE)), 2),
  sd = round(sapply(hotel_clean[nowe_zmienne], function(x) sd(x, na.rm = TRUE)), 2),
  Q1 = sapply(hotel_clean[nowe_zmienne], function(x) quantile(x, 0.25, na.rm = TRUE)),
  mediana = sapply(hotel_clean[nowe_zmienne], function(x) median(x, na.rm = TRUE)),
  Q3 = sapply(hotel_clean[nowe_zmienne], function(x) quantile(x, 0.75, na.rm = TRUE)),
  row.names = NULL) %>%
  datatable(caption = "Nowe zmienne", rownames = FALSE, options = list(paging = FALSE, dom = 't'))
```

## 4.2. Usuwanie zmiennych 
:::  {style="text-align: justify;"}
Ze zbioru danych wykluczono zmienne, ktÃ³re ze wzglÄ™du na koniecznoÅ›Ä‡ ochrony danch osobowych klientÃ³w, utowrzono sztucznie, a ktÃ³re uznano za nieistotne informacyjnie przy analizie gÅ‚Ã³wnych skÅ‚adowych (PCA) oraz analizie skupieÅ„. 

PominiÄ™to rÃ³wnieÅ¼ wybrane, nie niosÄ…ce istotnej wartoÅ›ci informacyjnej zmienne czasowe oraz zmienne opisujÄ…ce koÅ„cowy status rezerwacji. Uzasadnia siÄ™ to faktem, iÅ¼ zmienne te odnoszÄ… siÄ™ do zdarzeÅ„, ktÃ³re nastÄ…piÅ‚y po dokonaniu rezerwacji, a co za tym idzie - nie opisujÄ… one sytuacji klienta w momencie podejmowania decyzji, co mogÅ‚yby znieksztaÅ‚caÄ‡ wyniki przeprowadzanych analiz.

Dodatkowo, usuniÄ™to zmiennÄ… *kraj_pochodzenia*, ktÃ³ra charakteryzuje siÄ™ bardzo duÅ¼Ä… liczbÄ… kategorii. Jej uwzglÄ™dnienie w analizie mogÅ‚oby proawdziÄ‡ do nadmiernego zwiÄ™kszenia liczby zmiennych i utrudniania interpretacji wynikÃ³w.

UsuniÄ™te zmienne to:

- *imiÄ™_i_nazwisko*, *adres_email*, *numer_telefonu*, *numer_karty_kredytowej* â€“ zmienne sztuczne, nieistotne analitycznie,

- *dzieÅ„_przyjazdu_w_miesiÄ…cu*, *rok_przyjazdu* â€“ zmienne czasowe, nadmiarowe,

- *data_statusu_rezerwacji* â€“ zmienna opisujÄ…ca stan rezerwacji po jej realizacji,

- *kraj_pochodzenia* â€“ zmienna o bardzo duÅ¼ej liczbie kategorii.

We wczeÅ›niejszych etapach analizy usuniÄ™to takÅ¼e zmienne *firma* oraz *agent_rezerwacji* ze wzglÄ™du na wsytÄ™powanie wartoÅ›ci NA oraz nie wnoszenie istotnych informacji do analizy (zmienne bez znaczenia liczbowego, zawierajÄ…ce numery ID firm oraz agencji rezerwujÄ…cych pokoje).

W wyniku dodania nowych zmiennych, ktÃ³re scalajÄ… informacje z poszczegÃ³lnych z nich, wyklucza siÄ™ ze zbioru zmienne: *rodzaj_zarezerwowanego_pokoju*, *rodzaj_przydzielonego_pokoju*, *liczba_nocy_weekendowych*, *liczba_nocy_tygodniowych*, *liczba_dorosÅ‚ych*, *liczba_dzieci* i *liczba_niemowlÄ…t*.
:::

```{r usuwanie zmiennych, include=FALSE}
do_usuniecia <- c(
  "imiÄ™_i_nazwisko",
  "adres_email",
  "numer_telefonu",
  "numer_karty_kredytowej",
  "dzieÅ„_przyjazdu_w_miesiÄ…cu",
  "rok_przyjazdu",
  "data_statusu_rezerwacji",
  "kraj_pochodzenia",
  "rodzaj_zarezerwowanego_pokoju",
  "rodzaj_przydzielonego_pokoju",
  "liczba_nocy_weekendowych",
  "liczba_nocy_tygodniowych",
  "liczba_dorosÅ‚ych",
  "liczba_dzieci",
  "liczba_niemowlÄ…t")

hotel_clean <- hotel_clean %>%
  select(-all_of(do_usuniecia))
```

## 4.3. Standaryzacja i normalizacja

:::  {style="text-align: justify;"}
Zmienne iloÅ›ciowe zostaÅ‚y poddane standaryzacji metodÄ… Z-score w celu zapewnienia porÃ³wnywalnoÅ›ci skal oraz rÃ³wnowaÅ¼nego wpÅ‚ywu zmiennych na wyniki wybranych metod analizy (PCA oraz analiza skupieÅ„). 

Metoda ta zostaÅ‚a wybrana, poniewaÅ¼ analiza gÅ‚Ã³wnych skÅ‚adowych i analiza skupieÅ„ sÄ… wraÅ¼liwe na rÃ³Å¼nice skali zmiennych, a standaryzacja pozwala wyrÃ³wnaÄ‡ wpÅ‚yw kaÅ¼dej zmiennej na obliczenia odlegÅ‚oÅ›ci i wariancji, bez koniecznoÅ›ci zakÅ‚adania normalnoÅ›ci rozkÅ‚adu danych.  
Nie zdecydowano siÄ™ natomiast zastosowaÄ‡ normalizacji "min-max" (unitaryzacji) lub przeksztaÅ‚cenia ilorazowego, gdyÅ¼ mogÅ‚yby niepotrzebnie zmieniaÄ‡ strukturÄ™ danych (np. znieksztaÅ‚caÄ‡ odlegÅ‚oÅ›ci miÄ™dzy punktami ujednolicajÄ…c wpÅ‚yw zmiennych na odlegÅ‚oÅ›Ä‡), ktÃ³rym porÃ³wnywalnoÅ›Ä‡ zapewniÅ‚a standaryzacja Z-score.
:::

```{r standaryzacja z-score, include=FALSE}
# Dodanie nowej zmiennej do wektora zmeinne_ilosciowe i usuniÄ™cie pominiÄ™tych
zmienne_ilosciowe <- c(zmienne_ilosciowe, "liczba_nocy", "liczba_osÃ³b") %>%
  setdiff(c("liczba_nocy_weekendowych", "liczba_nocy_tygodniowych", "liczba_dorosÅ‚ych",
  "liczba_dzieci", "liczba_niemowlÄ…t"))

# Wyznaczenie zmiennych o zerowym odchyleniu
zmienne_stale <- sapply(hotel_clean[zmienne_ilosciowe], function(x) sd(x) == 0)

# WybÃ³r zmiennych niestaÅ‚ych do standaryzacji
zmienne_do_standaryzacji <- zmienne_ilosciowe[!zmienne_stale]


# STANDARYZACJA ZMIENNYCH ILOÅšCIOWYCH, NIESTAÅYCH
hotel_std <- hotel_clean[zmienne_do_standaryzacji] %>% 
  scale() %>% 
  as.data.frame()


# UsuniÄ™cie pominiÄ™tych zmiennych z wektora zmienne_kategoryczne
zmienne_kategoryczne <- zmienne_kategoryczne %>%
  setdiff(c("rok_przyjazdu", "dzieÅ„_przyjazdu_w_miesiÄ…cu", "rodzaj_przydzielonego_pokoju",
  "rodzaj_zarezerwowanego_pokoju"))

# Dodanie nowej zmiennej do wektora zmeinne_binarne
zmienne_binarne <- c(zmienne_binarne, "zmiana_pokoju")

# DoÅ‚Ä…czenie zmiennych kategorycznych i binarnych do zbioru hotel_std
hotel_std <- hotel_std %>%
  bind_cols(hotel_clean %>% select(all_of(c(zmienne_kategoryczne, zmienne_binarne))))

# DoÅ‚Ä…czenie zmiennej staÅ‚ej do zbioru hotel_std
hotel_std$liczba_niemowlÄ…t <- hotel_clean$liczba_niemowlÄ…t
```

:::  {style="text-align: justify;"}
Finalny zbiÃ³r po obrÃ³bce zawiera `r nrow(hotel_std)` obserwacji i `r ncol(hotel_std)` zmiennych.
:::

# 5. ZASTOSOWANIE METOD WIELOWYMIAROWYCH

## 5.1. PCA â€“ Analiza gÅ‚Ã³wnych skÅ‚adowych

:::  {style="text-align: justify;"}
W celu redukcji wymiarowoÅ›ci i zbadania struktury danych iloÅ›ciowych w zbiorze, zastosowano **analizÄ™ gÅ‚Ã³wnych skÅ‚adowych** ***(PCA â€“ Principal Component Analysis)***. Jest to metoda statystyczna, ktÃ³ra przeksztaÅ‚ca oryginalne zmienne w nowe, nieskorelowane czynniki, zwane *skÅ‚adowymi gÅ‚Ã³wnymi*. SkÅ‚adowe te sÄ… uporzÄ…dkowane na podstawie malejÄ…cego udziaÅ‚u objaÅ›niania caÅ‚kowitej wariancji danych, co pozwala na wydobycie z nich najbardziej istotnych informacji przy uÅ¼yciu mniejszej liczby wymiarÃ³w.

W kolejnych krokach przeprowadzono:

1. **AnalizÄ™ zaÅ‚oÅ¼eÅ„ PCA**, opartÄ… o ocenÄ™ korelacji miÄ™dzy zmiennymi, test Bartletta oraz kryterium KMO,

2.**DobÃ³r liczby skÅ‚adowych** z wykorzystaniem kryterium procentu skumulowanej wariancji, kryterium Keisera oraz kryterium Catella (wykresu osypiska),

3. **InterpretacjÄ™ wynikÃ³w** â€“ przedstawiono Å‚adunki czynnikowe ilustrujÄ…ce wkÅ‚ad zmiennych w poszczegÃ³lne wymiary, wizualizacjÄ™ korelacji zmiennych ze skÅ‚adowymi gÅ‚Ã³wnymi i wykres udziaÅ‚u zmiennoÅ›ci objaÅ›nianej przez skÅ‚adowe (cosÂ²).

Ze wzglÄ™du na duÅ¼Ä… liczbÄ™ obserwacji (116 661), aby uniknÄ…Ä‡ overplottingu, zrezygnowano z wizualizacji wspÃ³Å‚rzÄ™dnych obserwacji w przestrzeni gÅ‚Ã³wnych skÅ‚adowych oraz biplotu.

Do analizy wÅ‚Ä…czono `r length(zmienne_ilosciowe)` zmiennych iloÅ›ciowych, wybranych z pierwotnego zbioru zawierajÄ…cego `r ncol(hotel_std)` zmiennych. PozostaÅ‚e zmienne, ze wzglÄ™du na charakter jakoÅ›ciowy, nie zostaÅ‚y uwzglÄ™dnione w procedurze PCA.
:::

### 5.1.1. Sprawdzenie zaÅ‚oÅ¼eÅ„ analizy PCA

***1) Macierz korelacji***

:::  {style="text-align: justify;"}
W tym kroku ponownie sprawdzono wzajemne powiÄ…zania zmiennych iloÅ›ciowych, tym razem na danych finalnych, po obrÃ³bce zmiennych.
:::

```{r zaÅ‚oÅ¼enie PCA - macierz korelacji, echo=FALSE, message=FALSE, warning=FALSE}
hotelCorr<-cor(hotel_std[zmienne_ilosciowe])

ggcorrplot(hotelCorr,tl.cex=9,lab=TRUE,lab_size=2.5,p.mat = hotelCorr)
```
:::  {style="text-align: justify;"}
W przedstawionej macierzy korelacji moÅ¼na wydedukowaÄ‡, Å¼e istniejÄ… pewne istotne korelacje miÄ™dzy zmiennymi w zbiorze.


***2) Test Bartletta***

:::  {style="text-align: justify;"}
*H0: Macierz korelacji jest macierzÄ… jednostkowÄ… (zmienne nie sÄ… skorelowane) - nie ma sensu    wykonywaÄ‡ PCA*
*H1: Macierz korelacji nie jest macierzÄ… jednostkowÄ… (zmienne sÄ… skorelowane) - warto wykonywaÄ‡ redukcjÄ™ wymiaru, analizÄ™ PCA*
:::

```{r zaÅ‚oÅ¼enia PCA - test bartletta, echo=FALSE, message=FALSE, warning=FALSE}
cortest.bartlett(hotel_std[zmienne_ilosciowe]) %>%
  as.data.frame() %>%
  mutate(chisq = round(chisq, 3)) %>%
  datatable(rownames = FALSE, 
            caption = "Wyniki testu Bartletta",
            options = list(dom = 't', paging = FALSE))
```

:::  {style="text-align: justify;"}
Na podstawie testu Bartletta i p-value = 0 < alfa = 0,05 odrzucono H0 na rzecz HA stwierdzajÄ…c, Å¼e macierz korelacji badanego zbioru danych iloÅ›ciowych nie jest macierzÄ… jednostkowÄ…, wobec czego warto wkonaÄ‡ redukcjÄ™ wymiaru.
:::

***3) Kryterum KMO (Keisera-Meyera-Olkina)***

```{r zaÅ‚oÅ¼enia PCA - KMO, echo=FALSE}
kmo_res <- KMO(hotel_std[zmienne_ilosciowe])

data.frame(
  Zmienna = names(kmo_res$MSAi),
  MSA = round(kmo_res$MSAi, 3)) %>%
  datatable(rownames = FALSE,
            caption = paste0("Miary KMO (MSA) dla zmiennych - Overall MSA = ", round(kmo_res$MSA, 2)),
            options = list(dom = 't', paging = FALSE, ordering = FALSE)) %>%
  formatRound("MSA", 2)
```

:::  {style="text-align: justify;"}
WedÅ‚ug ogÃ³lnie przyjmowanych progÃ³w dla MSA, tj.:

~0.5 - kryterium KMO nie roztrzyga, czy warto wykonywaÄ‡ PCA

>0.5 - warto wykonywaÄ‡ PCA

<0.5 - nie ma sensu wykonywaÄ‡ PCA

moÅ¼na uznaÄ‡, Å¼e warto wykonaÄ‡ analizÄ™ gÅ‚Ã³wnych skÅ‚adowych dla analizowanych zmiennych, gdyÅ¼ wynoszÄ… one w wiÄ™kszoÅ›ci wiecej lub blisko 0,5. Potwierdza to rÃ³wnieÅ¼ *Overall MSA* wynoszÄ…ce 0,58.
:::

### 5.1.2. OkreÅ›lenie liczby skÅ‚adowych do redukcji

```{r pca, include=FALSE}
pca <- prcomp(hotel_std[zmienne_ilosciowe], center = TRUE, scale. = TRUE)
```

***1) Kryterium procentu wariancji***

```{r kryterium udziaÅ‚u zmiennoÅ›ci, echo=FALSE}
get_eig(pca) %>%
  rename_with(~ c("wartoÅ›Ä‡ wÅ‚asna",  "% wariancji", "skumulowany % wariancji"), .cols = c("eigenvalue",  "variance.percent", "cumulative.variance.percent")) %>%
  datatable(get_eig(pca), caption = "Kryterium udziaÅ‚u zmiennoÅ›ci", options = list(dom = 't', paging = FALSE, ordering = FALSE)) %>%
  formatRound(c("wartoÅ›Ä‡ wÅ‚asna",  "% wariancji", "skumulowany % wariancji"), 2)
```

:::  {style="text-align: justify;"}
**Skumulowana wariancja procentowa** (> 80%) wskazaÅ‚a, Å¼e najkorzystnieszÄ… opcjÄ… dla wybranych zmiennych jest zredukowanie ich do `r 4-1` wymiarÃ³w.
:::

***2) Kryterium Keisera***

:::  {style="text-align: justify;"}
**WartoÅ›Ä‡ wÅ‚asna**, zaprezentowana w tabeli *"Kryterium udziaÅ‚u zmiennoÅ›ci"* przekracza $*1*$ dla 4 zmiennych, co rÃ³wnieÅ¼ sugeruje zastosowanie 3 wymiarÃ³w.
:::

***3) kryterium Catella***

```{r wykres osypiska, echo=FALSE}
fviz_screeplot(pca, addlabels=TRUE)
```

:::  {style="text-align: justify;"}
**Wykres osypiska** natomiast uwidoczniÅ‚ punkt przegiÄ™cia w 3 wymiarze - co za tym idzie, wedÅ‚ug *kryterium Catella* naleÅ¼y zastosowaÄ‡ `r 3-1` wymiary.
:::

:::  {style="text-align: justify;"}
***Wniosek***
Na podstawie powyÅ¼szej analizy uznano, Å¼e najbardziej dopasowanÄ… liczbÄ… wymiarÃ³w, do ktÃ³rych naleÅ¼y zredukowaÄ‡ analizowane zmienne to **3**.
:::

### 5.1.3. Interpretacja wynikÃ³w PCA

```{r Å‚adunki czynnikowe, echo=FALSE}
pcaVars <- get_pca_var(pca)

ggcorrplot(t(pcaVars$coord[,1:3]),colors = c("#4361ee","white","#e63946"),
           tl.cex=9,lab=TRUE,lab_size=3)

contrib_df <- as.data.frame(pcaVars$contrib[, 1:3])
contrib_df$Zmienna <- rownames(contrib_df)

contrib_df %>%
  pivot_longer(
    cols = starts_with("Dim"),
    names_to = "SkÅ‚adowa",
    values_to = "WkÅ‚ad") %>%
  ggplot(aes(x = Zmienna, y = WkÅ‚ad, fill = SkÅ‚adowa)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ SkÅ‚adowa, scales = "free_x") +
  scale_fill_manual(values = c("Dim.1" = "#e27396",
                               "Dim.2" = "#5fa8d3", 
                               "Dim.3" = "#709775")) +
  geom_hline(yintercept = 10,
             linetype = "dashed",
             color = "red") +
  geom_text(aes(
    label = paste0(round(WkÅ‚ad, 1), "%"),
    hjust = ifelse(WkÅ‚ad < 5.5, -0.1, 1.1)),
    size = 2.5) +
  coord_flip() +
  labs(title = "WkÅ‚ad zmiennych w gÅ‚Ã³wne skÅ‚adowe PCA",
       y = "WkÅ‚ad (%)",
       x = "") +
  theme_minimal()

#### propozycja 2
contrib1 <- fviz_contrib(pca, choice = "var", axes = 1,
                       title = "WkÅ‚ad zmiennych w Dim.1",
                       fill = "#e27396",
                       color = "#e27396")

contrib1 +
  ylab("WkÅ‚ad (%)") +
  geom_text(aes(label = paste0(round(contrib, 1), "%")), 
            vjust = -0.5,
            size = 3,
            color = "black") +
  ylim(0, max(contrib1$data$contrib) * 1.1)



contrib2 <- fviz_contrib(pca, choice = "var", axes = 2,
                       title = "WkÅ‚ad zmiennych w Dim.2",
                       fill = "#5fa8d3",
                       color = "#5fa8d3")

contrib2 +
  ylab("WkÅ‚ad (%)") +
  geom_text(aes(label = paste0(round(contrib, 1), "%")), 
            vjust = -0.5,
            size = 3,
            color = "black") +
  ylim(0, max(contrib2$data$contrib) * 1.1)



contrib3 <- fviz_contrib(pca, choice = "var", axes = 3,
                       title = "WkÅ‚ad zmiennych w Dim.3",
                       fill = "#709775",
                       color = "#709775")

contrib3 +
  ylab("WkÅ‚ad (%)") +
  geom_text(aes(label = paste0(round(contrib, 1), "%")), 
            vjust = -0.5,
            size = 3,
            color = "black") +
  ylim(0, max(contrib3$data$contrib) * 1.1)
```

:::  {style="text-align: justify;"}
WspÃ³Å‚czynniki korelacji miÄ™dzy oryginalnymi zmiennymi a nowo utworzonymi skÅ‚adowymi (**Å‚adunki czynnikowe**) ukazujÄ…, ktÃ³re z nich najsilniej (a ktÃ³re najsÅ‚abiej) oddziaÅ‚ywaÅ‚y na danÄ… skÅ‚adowÄ… gÅ‚Ã³wnÄ…. O znaczeniu zmiennej decydowaÅ‚ jej procentowy wkÅ‚ad w danÄ… skÅ‚adowÄ… (> 10%), natomiast znak Å‚adunku okreÅ›laÅ‚ kierunek zaleÅ¼noÅ›ci.

Najbardziej wpÅ‚ywajÄ…ce na utworzone wymiary zmienne to:

***Wymiar 1.***

- *Å›rednia_cena_za_noc* (29,0%, negatywny wpÅ‚yw)

- *liczba_osÃ³b* (27,3%, negatywny wpÅ‚yw)

- *liczba_specjalnych_prÃ³Å›b* (15,3%, negatywny wpÅ‚yw)

- *wczeÅ›niejsze_odwoÅ‚ania* (10,3%, dodatni wpÅ‚yw)

***Wymiar 2.***

- *czas_wyprzedzenia_rezerwacji* (37,8%, negatywny wpÅ‚yw)

- *wczeÅ›niejsze_rezerwacje_nieodwoÅ‚ane* (15,7%, dodatni wpÅ‚yw)

- *wymagane_miejsca_parkingowe* (12,3%, dodatni wpÅ‚yw)

***Wymiar 3.***

- *liczba_zmian_rezerwacji* (50,2%, negatywny wpÅ‚yw)

- *liczba_nocy* (28,2%, negatywny wpÅ‚yw)


Wobec powyÅ¼szego, zrÃ³Å¼nicowanie rezerwacji hotelowych opisane zostaÅ‚o za pomocÄ… trzech gÅ‚Ã³wnych cech:

> **profil cenowy i preferencje klientÃ³w** (pierwsza skÅ‚adowa gÅ‚Ã³wna)
> **planowanie rezerwacji** (druga skÅ‚adowa gÅ‚Ã³wna)
> **elastycznoÅ›Ä‡ i dÅ‚ugoÅ›Ä‡ pobytu w hotelu** (trzecia skÅ‚adowa gÅ‚Ã³wna)


KorelacjÄ™ zmiennych oryginalnych z poszczegÃ³lnymi skÅ‚adowymi gÅ‚Ã³wnymi przedstawia poniÅ¼sza grafika.
:::

```{r wykresy zmiennych pca, echo=FALSE}
fviz_pca_var(pca, axes=c(1,2), repel = TRUE, labelsize=3, col.var = "cos2",
             gradient.cols = c("#4da1a9", "#3d348b", "#c9184a"))

fviz_pca_var(pca, axes=c(1,3), repel = TRUE,labelsize=3, col.var = "cos2",
             gradient.cols = c("#4da1a9", "#3d348b", "#c9184a"))

fviz_pca_var(pca, axes=c(2,3), repel = TRUE, labelsize=3, col.var = "cos2",
             gradient.cols = c("#4da1a9", "#3d348b", "#c9184a"))
```
:::  {style="text-align: justify;"}
Z wykresÃ³w korelacji zmeinnych PCA wynika, Å¼e pierwsza gÅ‚Ã³wna skÅ‚adowa (*Dim1*) wraz z drugÄ… (*Dim2*) Å‚Ä…cznie wyjaÅ›niajÄ… `r 14.4+17.1`% caÅ‚kowitej wariancji danych. UwzglÄ™dnienie trzeciej skÅ‚adowej (*Dim3*) zwiÄ™ksza dodatkowo ten odsetek do `r 14.4+17.1+10.9`%. 

Na wykresach widoczne sÄ… wyraÅºne grupy zmiennych o zbliÅ¼onych kierunkach wektorÃ³w (np. w *Dim1-Dim2* para *wymagane_miejsca_parkingowe* i *liczba_specjalnych_prÃ³Å›b*, czy w *Dim2-Dim3* para *Å›rednia_cena_za_noc* oraz *liczba_osÃ³b*), co wskazuje na ich dodatniÄ… korelacjÄ™, oraz zmienne skierowane przeciwnie (np. w *Dim1-Dim3* para *liczba_specjalnych_prÃ³Å›b* i *wczeÅ›niejsze_odwoÅ‚ania*), Å›wiadczÄ…ce o ich ujemnym powiÄ…zaniu. DÅ‚ugoÅ›Ä‡ wektorÃ³w natomiast potwierdza, Å¼e zmienne wskazane wczeÅ›niej jako istotne dla poszczegÃ³lnych wymiarÃ³w sÄ… wÅ‚aÅ›ciwie przedstawiane w przestrzeni gÅ‚Ã³wnych skÅ‚adowych.
:::

```{r wykres objaÅ›niania zmiennoÅ›ci przez wymiary}
# WyÅ›wietlenie zasobÃ³w zmiennoÅ›ci wspÃ³lnej w celu sprawdzenia jaka czÄ™Å›Ä‡ zmiennoÅ›ci danej zmiennej byÅ‚a wyjaÅ›niana przez kolejne skÅ‚adowe

cos2_1 <- fviz_cos2(pca, choice = "var", axes = 1,
                       title = "Cos2 zmiennych w Dim.1",
                       fill = "#e27396",
                       color = "#e27396")
cos2_1 +
  ylab("Cos2 - jakoÅ›Ä‡ reprezentacji") +
  geom_text(aes(label = paste0(round(cos2, 3)*100, "%")), 
            vjust = -0.5,
            size = 3,
            color = "black") +
  ylim(0, max(cos2_1$data$cos2) * 1.1)



cos2_2 <- fviz_cos2(pca, choice = "var", axes = 2,
                       title = "Cos2 zmiennych w Dim.2",
                       fill = "#5fa8d3",
                       color = "#5fa8d3")
cos2_2 +
  ylab("Cos2 - jakoÅ›Ä‡ reprezentacji") +
  geom_text(aes(label = paste0(round(cos2, 3)*100, "%")), 
            vjust = -0.5,
            size = 3,
            color = "black") +
  ylim(0, max(cos2_2$data$cos2) * 1.1)



cos2_3 <- fviz_cos2(pca, choice = "var", axes = 3,
                       title = "Cos2 zmiennych w Dim.3",
                       fill = "#709775",
                       color = "#709775")
cos2_3 +
  ylab("Cos2 - jakoÅ›Ä‡ reprezentacji") +
  geom_text(aes(label = paste0(round(cos2, 3)*100, "%")), 
            vjust = -0.5,
            size = 3,
            color = "black") +
  ylim(0, max(cos2_3$data$cos2) * 1.1)
```

:::  {style="text-align: justify;"}
***Wymiar 1.*** ponadto reprezentowaÅ‚ w najwiÄ™kszej mierze zmiennoÅ›Ä‡ *Å›redniej ceny za noc* (49,8%) oraz *liczby osÃ³b* (46,8%). 

***Wymiar 2.*** odpowiadaÅ‚ za objaÅ›nienie w 54,3% wariancji *czasu wprzedzenia rezerwacji*. 

***Wymiar 3.*** natomiast objaÅ›niÅ‚ gÅ‚Ã³wnie zmiennoÅ›Ä‡ *liczby zmian rezerwacji* (w 54,9%) oraz *liczby nocy* (w 30,9%).
:::

## 5.2. Analiza skupieÅ„

::: {style="text-align: justify;"} 
W kolejnym etapie przeprowadzono **analizÄ™ skupieÅ„** z wykorzystaniem metody podziaÅ‚u rozÅ‚Ä…cznego - metody ***k-Å›rednich (k-means)***. Polega ona na podziale zbioru obserwacji na okreÅ›lonÄ… liczbÄ™ jednorodnych grup w taki sposÃ³b, aby obiekty wewnÄ…trz klastrÃ³w byÅ‚y do siebie jak najbardziej podobne, natomiast rÃ³Å¼niÅ‚y siÄ™ maksymalnie od obiektÃ³w z pozostaÅ‚ych skupieÅ„. Dzieje siÄ™ to za sprawÄ… minimalizacji sumy kwadratÃ³w odlegÅ‚oÅ›ci obserwacji od centroidÃ³w klastrÃ³w, a co pozwala dokonaÄ‡ najbardziej skutecznego grupowania danych.

WybÃ³r metody **k-Å›rednich** jest uzasadniony przede wszystkim duÅ¼Ä… liczebnoÅ›ciÄ… zbioru danych (ponad 119 tys. obserwacji), ktÃ³ra sprawia, Å¼e zastosowanie klasycznych metod hierarchicznych (np. Warda) stajÄ… siÄ™ zbyt zÅ‚oÅ¼one obliczeniowo, a co w przypadku **k-means** - jest moÅ¼liwe do wykonania.

Dodatkowo, przed przystÄ…pieniem do klasteryzacji wszystkie zmienne iloÅ›ciowe poddano standaryzacji, co zapewniÅ‚o ich porÃ³wnywalnoÅ›Ä‡ i zapobiegÅ‚o dominacji zmiennych o wiÄ™kszej skali.

Podobnie jak w przypadku analizy PCA - do przeprowadzenia analizy skupieÅ„ uÅ¼yto `r length(zmienne_ilosciowe)` zmiennych ze zbioru po obrÃ³bce, liczÄ…cego `r ncol(hotel_std)` zmiennych.

W kolejnych etapach dokonano:

1.  **OkreÅ›lania optymalnej liczby skupieÅ„** przy pomocy metody Å‚okcia,
    indeksu sylwetkowego oraz statystyki GAP,

2.  **WÅ‚aÅ›ciwÄ… analizÄ™ k-means** na peÅ‚nym zbiorze danych przy wybranej
    liczbie klastrÃ³w, z wykorzystaniem 25 losowych inicjalizacji
    centroidÃ³w, w celu zwiÄ™kszenia stabilnoÅ›ci wynikÃ³w,

3.  **AnalizÄ™ centrÃ³w klastrÃ³w**, co zakÅ‚adaÅ‚o wyznaczenie Å›rednich
    wartoÅ›ci zmiennych w poszczegÃ³lnych skupieniach oraz ich
    interpretacjÄ™,

4.  **Przypisania obserwacji do klastrÃ³w** i doÅ‚Ä…czenie informacji o
    przynaleÅ¼noÅ›ci do oryginalnego zbioru danych,

5.  **Wizualizacji wynikÃ³w segmentacji**, zarÃ³wno w przestrzeni
    zredukowanej do dwÃ³ch wymiarÃ³w, jak i na wykresach rozrzutu dla
    wybranych zmiennych, w celu oceny jakoÅ›ci i interpretowalnoÅ›ci
    uzyskanych skupieÅ„.
:::::::::::::

### 5.2.1. OkreÅ›lanie optymalnej liczby skupieÅ„
::: {style="text-align: justify;"}
*Z uwagi na bardzo duÅ¼Ä… liczebnoÅ›Ä‡ zbioru danych, obliczenia znajdujÄ…ce
siÄ™ w tym kroku zostaÅ‚y przeprowadzone na losowej prÃ³bie obejmujÄ…cej
5000 obserwacji. PrÃ³ba ta byÅ‚a konieczna, poniewaÅ¼ funkcje sÅ‚uÅ¼Ä…ce do
wyznaczania miar jakoÅ›ci klasteryzacji wymagajÄ… tworzenia duÅ¼ych
macierzy odlegÅ‚oÅ›ci, ktÃ³rych obliczenie dla peÅ‚nego zbioru przekraczaÅ‚o
moÅ¼liwoÅ›ci obliczeniowe programu R. Dodatkowo podjÄ™to prÃ³bÄ™
wykorzystania pakietu NbClust, jednak nawet po ograniczeniu liczby
obserwacji funkcja ta nie zadziaÅ‚aÅ‚a poprawnie z uwagi na zbyt duÅ¼Ä…
zÅ‚oÅ¼onoÅ›Ä‡ obliczeÅ„.*
::::
```{r PrÃ³bka, include=FALSE}
# Definowanie losowej prÃ³bki ze zbioru hotel_std
#set.seed(123)  # ustawianie powtarzalnoÅ›ci prÃ³bki dla dalszych 
#sample_idx <- sample(1:nrow(hotel_std), 15000)  # losowa prÃ³bka 5000 wierszy
#hotel_sample <- hotel_std[sample_idx, zmienne_ilosciowe]

# Zapisanie prÃ³bki do pliku w celu zapewnienia powtarzalnoÅ›ci wynikÃ³w
#saveRDS(hotel_sample, "hotel_sample_10.rds")

# Wczytanie prÃ³bek, na podstawie ktÃ³rych przeprowadzono analizÄ™ optymalnych liczby klastrÃ³w
hotel_sample_5 <- readRDS("hotel_sample_5.rds")
hotel_sample_10 <- readRDS("hotel_sample_10.rds")
```


***1) Metoda Å‚okciowa WSS (Elbow Method)***

::: {style="text-align: justify;"}
Pierwsza z trzech obiektywnych metod wyboru liczby skupieÅ„ jest *metoda Å‚okciowa*, ktÃ³ra polega na analizie zmiany sumy kwadratÃ³w odlegÅ‚oÅ›ci wewnÄ…trz skupieÅ„ (WSS) w zaleÅ¼noÅ›ci od liczby klastrÃ³w.  
OptymalnÄ… liczbÄ™ skupieÅ„ wybiera siÄ™ w miejscu, w ktÃ³rym dalsze zwiÄ™kszanie liczby klastrÃ³w nie powoduje juÅ¼ istotnego zmniejszenia siÄ™ wewnÄ™trznego zrÃ³Å¼nicowania danych *(WSS)*.
:::

```{r metoda Å‚okciowa, echo=FALSE}
# Wyznaczenie sumy kwadratÃ³w odchyleÅ„ wewnÄ…trz skupieÅ„ (WSS) dla kolejnych wartoÅ›ci liczby klastrÃ³w
# + zwiÄ™kszenie inicjacji wynikÃ³w w celu zwiÄ™kszenia stabilnoÅ›ci wynikÃ³w
fviz_nbclust(hotel_sample_5, FUN = kmeans, method = "wss", nstart = 5)
```

***2) Indeks sylwetkowy (Silhouette Index)***

::: {style="text-align: justify;"}
DrugÄ… metodÄ… jest *indeks sylwetkowy*, ktÃ³ry mierzy jakoÅ›Ä‡ przypisania obserwacji do skupieÅ„, porÃ³wnujÄ…c podobieÅ„stwo obiektÃ³w wewnÄ…trz klastra z ich odlegÅ‚oÅ›ciÄ… od innych klastrÃ³w.  
Optymalna liczba skupieÅ„ odpowiada maksymalnej Å›redniej wartoÅ›ci *indeksu sylwetki*.
:::

```{r indeks sylwetkowy}
fviz_nbclust(hotel_sample_5, FUN = kmeans, method = "silhouette", nstart = 5)
```

***1) Statystyka GAP (GAP Statistic)***

::: {style="text-align: justify;"}
OstatniÄ…, trzeciÄ… metodÄ… jest *statystyka GAP* porÃ³wnujÄ…ca jakoÅ›Ä‡ grupowania, ktÃ³ra zostaÅ‚a uzyskana dla danych rzeczywistych z jakoÅ›ciÄ… grupowania dla danych losowych o tej samej strukturze.  
Optymalna liczba skupieÅ„ to taka, dla ktÃ³rej wartoÅ›Ä‡ *statystyki GAP* jest najwiÄ™ksza.
:::

```{r statystyka GAP, echo=FALSE}
library(cluster)
gap_stat <- clusGap(hotel_sample_5, FUN = kmeans, nstart = 5, K.max = 10, B = 10)

fviz_gap_stat(gap_stat)

# kod na prÃ³bce 10 tys. obserwacji, nstart = 5, B = 10 wskazuje 1 klaster
# kod na prÃ³bce 10 tys. obserwacji, nstart = 1 (domyÅ›lnie) i B = 20 wskazuje 1 klaster
# kod na prÃ³bce 5 tys. obserwacji, nstart = 5, B = 10 wskazuje 10+ klastrÃ³w
# kod na prÃ³bce 5 tys. obserwacji, nstart = 1 (domyÅ›lnie) i wskazanych parametrach wskazuje 10+ klastrÃ³w
```

::: {style="text-align: justify;"}
Przez wzglÄ…d na dÅ‚ugoÅ›Ä‡ wyÅ›wietlania wykresu dla prÃ³bki, zdecydowano siÄ™ ujÄ…Ä‡ wynik sÅ‚ownie.

- statystyka GAP na prÃ³bce 10 tys. obserwacji, 5 inicjacjach, B = 10 wskazuje 1 klaster
- statystyka GAP na prÃ³bce 10 tys. obserwacji, nstart = 1 (domyÅ›lnie) i B = 20 wskazuje 1 klaster
- statystyka GAP na prÃ³bce 5 tys. obserwacji, nstart = 5, B = 10 wskazuje 10+ klastrÃ³w
- statystyka GAP na prÃ³bce 5 tys. obserwacji, nstart = 1 (domyÅ›lnie) i B = 10 wskazuje 10+ klastrÃ³w

WNIOSEK:
Statystyka GAP w danym przypadku nie jest jednoznaczna we wskazaniu optymalnej liczby klastrÃ³w. ZauwaÅ¼yÄ‡ jednak moÅ¼na, Å¼e im liczniejsza byÅ‚a prÃ³bka pobrana z danych *(hotel_std)* i im wiÄ™kszy byÅ‚ ustalony poziom interacji, wskazywaÅ‚a ona coraz mniejszÄ… liczbÄ™ klastrÃ³w.  
Uznano wiÄ™c, Å¼e wskazana liczba zna
:::

### 4.2.2. WÅ‚aÅ›ciwa analiza *k-means*

```{r k-means, echo=FALSE}
# Klasteryzacja metodÄ… k-Å›rednich z podziaÅ‚em na 6 skupieÅ„
hotel_k6 <- kmeans(hotel_std[zmienne_ilosciowe], centers = 2, nstart = 25)
```

::: {style="text-align: justify;"}
...
:::

### 4.2.3. Analiza centrÃ³w klastrÃ³w

```{r}
# WyÅ›wietlenie centroidÃ³w klastrÃ³w (wartoÅ›ci w skali standaryzowanej)
hotel_k6$centers

library(ggplot2)
library(reshape2)

centers_df <- as.data.frame(hotel_k6$centers)
centers_df$Cluster <- 1:nrow(centers_df)

centers_melt <- melt(centers_df, id.vars = "Cluster")

ggplot(centers_melt, aes(x = variable, y = factor(Cluster), fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  labs(x = "Zmienne", y = "Klastry", fill = "WartoÅ›Ä‡") +
  theme_minimal()

```

::: {style="text-align: justify;"}
...
:::

### 4.2.4. Przypisanie obserwacji do klastrÃ³w

```{r przypisanie numeru klastra do obserwacji, echo=FALSE}
# DoÅ‚Ä…czenie informacji o przypisaniu obserwacji do klastrÃ³w
hotel_group <- data.frame(hotel_std[zmienne_ilosciowe], Group = hotel_k6$cluster)

# Obliczenie Å›rednich wartoÅ›ci zmiennych w poszczegÃ³lnych klastrach ---- ?????
hotel_centers <- as.data.frame(aggregate(.~Group, data = hotel_group, FUN = mean))

# Zamiana na dÅ‚ugi format (long) do ggplot
hotel_long <- pivot_longer(hotel_centers, cols = -Group, names_to = "Variable", values_to = "Mean")

ggplot(hotel_long, aes(x = Variable, y = Mean, fill = factor(Group))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(fill = "Klaster", x = "Zmienna", y = "Åšrednia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
library(fmsb)

# fmsb wymaga, Å¼eby dane byÅ‚y w formacie: pierwsze dwa wiersze = max i min dla skali
max_vals <- apply(hotel_centers[,-1], 2, max)
min_vals <- apply(hotel_centers[,-1], 2, min)

radar_data <- rbind(max_vals, min_vals, hotel_centers[,-1])
rownames(radar_data) <- c("Max", "Min", paste0("Klaster_", hotel_centers$Group))

# Rysowanie wykresu radarowego
colors_border <- rainbow(nrow(hotel_centers))
radarchart(radar_data,
           axistype = 1,
           pcol = colors_border,
           pfcol = scales::alpha(colors_border, 0.3),
           plwd = 2,
           cglcol = "grey",
           cglty = 1,
           axislabcol = "grey",
           caxislabels = round(seq(min(min_vals), max(max_vals), length.out = 5),1),
           vlcex = 0.8)
legend("topright", legend = paste0("Klaster ", hotel_centers$Group), bty = "n", pch=20, col=colors_border)

```

::: {style="text-align: justify;"}
...
:::

### 4.2.5. Wizualizacja wynikÃ³w segmentacji

```{r wizualizacja wynikÃ³w analizy, echo=FALSE}
# Wizualizacja wynikÃ³w klasteryzacji w przestrzeni wielowymiarowej (dwa wymiary)
fviz_cluster(hotel_k6, data = hotel_std[zmienne_ilosciowe], geom = "point")
```

::: {style="text-align: justify;"}
Wizualizacja wynikÃ³w klasteryzacji z wykorzystaniem metody k-Å›rednich
dla szeÅ›ciu klastrÃ³w wskazuje na wyraÅºnÄ… segmentacjÄ™ obserwacji.
WiÄ™kszoÅ›Ä‡ skupieÅ„ tworzy spÃ³jne i rozpoznawalne grupy, choÄ‡ czÄ™Å›Ä‡ z nich
czÄ™Å›ciowo nakÅ‚ada siÄ™ na siebie, co wynika z wielowymiarowego charakteru
danych. Widoczna struktura klastrÃ³w potwierdza jednak istnienie
zrÃ³Å¼nicowanych profili rezerwacji, a zastosowanie metody k-means moÅ¼na
uznaÄ‡ za uzasadnione i efektywne w kontekÅ›cie analizowanego zbioru.
:::


```{r wykres rozrzutu dla dwÃ³ch wybranych zmiennych, echo=FALSE}
# Konwersja numeru grupy na zmiennÄ… kategorycznÄ…
hotel_group$Group <- as.factor(hotel_group$Group)

# Wizualizacja klastrÃ³w na wykresie - "zmienna" vs "zmienna"
library(ggpubr)
ggscatter(x = "liczba_nocy", y = "Liczba_osÃ³b", color = "Group", data = hotel_group)
```

::: {style="text-align: justify;"}
...
:::

#3) statystyka gap

# 5. PORÃ“WNANIE METOD I WIZUALIZACJA WYNIKÃ“W

PorÃ³wnane zostanÄ… wyniki PCA i klasteryzacji, a takÅ¼e ich interpretacje.
Wizualizacje obejmÄ… m.in. biploty, wykresy skupieÅ„ oraz wykresy 2D/3D
(kaÅ¼dy wykres powinien mieÄ‡ opis i krÃ³tki komentarz)

# 6. Wnioski z analizy
